[{"title":"Hello World","url":"/2022/10/20/hello-world/","content":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n"},{"title":"æµ‹è¯•æ–‡ç« ","url":"/2022/10/20/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/","content":"<p>è¿™æ˜¯ä¸€ç¯‡æµ‹è¯•æ–‡ç« ã€‚</p>\n<ul>\n<li>æµ‹è¯•åœ¨hexo-blogæ–‡ä»¶å¤¹ä¸‹è¿è¡Œhexo clean &amp;&amp; hexo deployæ˜¯å¦å¯ä»¥æ‰§è¡ŒæˆåŠŸã€‚âˆš</li>\n<li>æµ‹è¯•åœ¨hexo-blogæ–‡ä»¶å¤¹ä¸‹è¿è¡Œhexo generate &amp;&amp; hexo deployæ˜¯å¦å¯ä»¥æ‰§è¡ŒæˆåŠŸã€‚âˆš</li>\n<li>æ¨èï¼šhexo clean &amp;&amp; hexo g &amp;&amp; hexo d</li>\n</ul>\n<img src=\"/2022/10/20/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/%E6%98%9F%E5%A4%9C.jpg\" class=\"\" title=\"å›¾ç‰‡å¼•ç”¨æ–¹æ³•ä¸€\">\n\n","categories":["æµ‹è¯•"],"tags":["æµ‹è¯•"]},{"title":"Cephæºç åˆ†æ","url":"/2022/10/22/Ceph%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","content":"<h1 id=\"ã€ŠCephæºç åˆ†æã€‹æ‘˜è¦\"><a href=\"#ã€ŠCephæºç åˆ†æã€‹æ‘˜è¦\" class=\"headerlink\" title=\"ã€ŠCephæºç åˆ†æã€‹æ‘˜è¦\"></a>ã€ŠCephæºç åˆ†æã€‹æ‘˜è¦</h1><h2 id=\"Cephæ•´ä½“ç»“æ„\"><a href=\"#Cephæ•´ä½“ç»“æ„\" class=\"headerlink\" title=\"Cephæ•´ä½“ç»“æ„\"></a>Cephæ•´ä½“ç»“æ„</h2><h3 id=\"Cephè®¾è®¡ç›®æ ‡\"><a href=\"#Cephè®¾è®¡ç›®æ ‡\" class=\"headerlink\" title=\"Cephè®¾è®¡ç›®æ ‡\"></a>Cephè®¾è®¡ç›®æ ‡</h3><ol>\n<li>é«˜å¯ç”¨æ€§ï¼šCephä½¿ç”¨æ•°æ®å¤šå‰¯æœ¬ã€çº åˆ ç æä¾›æ•°æ®å†—ä½™ã€‚</li>\n<li>é«˜å¯æ‰©å±•æ€§<ul>\n<li>é›†ç¾¤å®¹é‡å¯ä»¥ä¼¸ç¼©ï¼Œå¯ä»¥ä»»æ„æ·»åŠ å’Œåˆ é™¤å­˜å‚¨èŠ‚ç‚¹ã€å­˜å‚¨è®¾å¤‡ã€‚</li>\n<li>ç³»ç»Ÿæ€§èƒ½éšé›†ç¾¤çš„å¢åŠ è€Œçº¿æ€§å¢åŠ ã€‚</li>\n</ul>\n</li>\n<li>å¤§è§„æ¨¡ï¼šCephå­˜å‚¨ç³»ç»Ÿçš„è§„æ¨¡å¯ä»¥æ‰©å±•åˆ°æˆåƒä¸Šä¸‡èŠ‚ç‚¹ã€‚</li>\n</ol>\n<h3 id=\"CephåŸºæœ¬æ¶æ„å›¾\"><a href=\"#CephåŸºæœ¬æ¶æ„å›¾\" class=\"headerlink\" title=\"CephåŸºæœ¬æ¶æ„å›¾\"></a>CephåŸºæœ¬æ¶æ„å›¾</h3><p>Cephæ•´ä½“æ¶æ„æœ‰ä¸‰å±‚</p>\n<ol>\n<li>æœ€åº•å±‚æœ€æ ¸å¿ƒçš„RADOSå¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼šRADOSï¼ˆreliable, autonomous, distributed object storeï¼‰æ˜¯ä¸€ä¸ªå¯é çš„ã€è‡ªç»„ç»‡çš„ã€å¯è‡ªåŠ¨ä¿®å¤ã€è‡ªæˆ‘ç®¡ç†çš„åˆ†å¸ƒå¼å¯¹è±¡å­˜å‚¨ç³»ç»Ÿã€‚å…¶å†…éƒ¨åŒ…æ‹¬ ceph-osd åå°æœåŠ¡è¿›ç¨‹å’Œ ceph-mon ç›‘æ§è¿›ç¨‹ã€‚  </li>\n<li>ä¸­é—´å±‚libradosåº“ï¼šç”¨äºæœ¬åœ°æˆ–è¿œç¨‹é€šè¿‡ç½‘ç»œè®¿é—®RADOSå¯¹è±¡å­˜å‚¨ç³»ç»Ÿã€‚æ”¯æŒå¤šç§è¯­è¨€ï¼Œå¦‚C&#x2F;C++ã€Javaã€Pythonç­‰ã€‚</li>\n<li>æœ€ä¸Šå±‚Cephä¸åŒå½¢å¼çš„å­˜å‚¨æ¥å£å®ç°<ul>\n<li>å—å­˜å‚¨ç»“æ„ã€‚</li>\n<li>å¯¹è±¡å­˜å‚¨æ¥å£ã€‚</li>\n<li>æ–‡ä»¶ç³»ç»Ÿæ¥å£ã€‚</li>\n</ul>\n</li>\n</ol>\n<img src=\"/2022/10/22/Ceph%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ceph%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84%E5%9B%BE.png\" class=\"\" title=\"CephåŸºæœ¬æ¶æ„å›¾\">\n\n<h3 id=\"Cephå®¢æˆ·ç«¯æ¥å£\"><a href=\"#Cephå®¢æˆ·ç«¯æ¥å£\" class=\"headerlink\" title=\"Cephå®¢æˆ·ç«¯æ¥å£\"></a>Cephå®¢æˆ·ç«¯æ¥å£</h3><h4 id=\"RBD\"><a href=\"#RBD\" class=\"headerlink\" title=\"RBD\"></a>RBD</h4><p>RBDï¼ˆrados block deviceï¼‰é€šè¿‡ librbd åº“å¯¹åº”ç”¨æä¾›å—å­˜å‚¨ï¼Œä¸»è¦é¢å‘äº‘å¹³å°çš„è™šæ‹Ÿæœºæä¾›è™šæ‹Ÿç£ç›˜ã€‚ä¼ ç»Ÿ SAN å°±æ˜¯å—å­˜å‚¨ï¼Œé€šè¿‡ SCSI æˆ–è€… FC æ¥å£ç»™åº”ç”¨æä¾›ä¸€ä¸ªç‹¬ç«‹çš„ LUN æˆ–è€…å·ã€‚RBD ç±»ä¼¼äºä¼ ç»Ÿçš„ SAN å­˜å‚¨ï¼Œéƒ½æä¾›æ•°æ®å—çº§åˆ«çš„è®¿é—®ã€‚  </p>\n<h4 id=\"CephFS\"><a href=\"#CephFS\" class=\"headerlink\" title=\"CephFS\"></a>CephFS</h4><p>CephFS é€šè¿‡åœ¨ RADOS åŸºç¡€ä¹‹ä¸Šå¢åŠ äº† MDS ( Metadata Server) æ¥æä¾›æ–‡ä»¶å­˜å‚¨ã€‚å®ƒæä¾›äº† libcephfs åº“å’Œæ ‡å‡†çš„ P0SIX æ–‡ä»¶æ¥å£ã€‚ CephFS ç±»ä¼¼äºä¼ ç»Ÿçš„ NAS å­˜å‚¨ï¼Œé€šè¿‡ NFS æˆ–è€… CIFS åè®®æä¾›æ–‡ä»¶ç³»ç»Ÿæˆ–è€…æ–‡ä»¶ç›®å½•æœåŠ¡ã€‚</p>\n<h4 id=\"RadosGW\"><a href=\"#RadosGW\" class=\"headerlink\" title=\"RadosGW\"></a>RadosGW</h4><p>ï¼ˆçœ‹ä¸å¤ªæ˜ç™½</p>\n<h3 id=\"RADOS\"><a href=\"#RADOS\" class=\"headerlink\" title=\"RADOS\"></a>RADOS</h3><p>RADOSå®Œæˆäº†ä¸€ä¸ªå­˜å‚¨ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†ï¼š</p>\n<h4 id=\"Monitor\"><a href=\"#Monitor\" class=\"headerlink\" title=\"Monitor\"></a>Monitor</h4><p>Monitoræ¨¡å—ä¸ºæ•´ä¸ªå­˜å‚¨é›†ç¾¤æä¾›å…¨å±€çš„é…ç½®å’Œç³»ç»Ÿä¿¡æ¯ã€‚</p>\n<ol>\n<li>å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹éƒ¨ç½²çš„daemonè¿›ç¨‹ï¼Œé€šè¿‡ç»„æˆMonitoré›†ç¾¤æ¥ä¿è¯è‡ªå·±çš„é«˜å¯ç”¨æ€§ã€‚</li>\n<li>é€šè¿‡Paxosç®—æ³•å®ç°è‡ªå·±æ•°æ®çš„ä¸€è‡´æ€§ã€‚</li>\n<li>æä¾›æ•´ä¸ªå­˜å‚¨ç³»ç»Ÿçš„èŠ‚ç‚¹ä¿¡æ¯ç­‰å…¨å±€é…ç½®ä¿¡æ¯ã€‚</li>\n</ol>\n<p>Cluster Mapä¿å­˜äº†ç³»ç»Ÿçš„å…¨å±€ä¿¡æ¯ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>\n<ol>\n<li>Monitor Map<ul>\n<li>åŒ…æ‹¬é›†ç¾¤çš„fsidï¼›</li>\n<li>æ‰€æœ‰Monitorçš„åœ°å€å’Œç«¯å£ï¼›</li>\n<li>current epochã€‚</li>\n</ul>\n</li>\n<li>OSD Mapï¼šæ‰€æœ‰OSDçš„åˆ—è¡¨å’ŒOSDçš„çŠ¶æ€ç­‰ã€‚</li>\n<li>MDS Mapï¼šæ‰€æœ‰çš„MDSçš„åˆ—è¡¨å’ŒçŠ¶æ€ã€‚</li>\n</ol>\n<h4 id=\"å¯¹è±¡å­˜å‚¨\"><a href=\"#å¯¹è±¡å­˜å‚¨\" class=\"headerlink\" title=\"å¯¹è±¡å­˜å‚¨\"></a>å¯¹è±¡å­˜å‚¨</h4><p>è¿™é‡Œæ‰€è¯´çš„å¯¹è±¡æ˜¯æŒ‡ RADOS å¯¹è±¡ï¼Œè¦å’Œ RadosGW çš„ S3 æˆ–è€… Swift æ¥å£çš„å¯¹è±¡å­˜å‚¨åŒºåˆ†å¼€æ¥ã€‚å¯¹è±¡æ˜¯æ•°æ®å­˜å‚¨çš„åŸºæœ¬å•å…ƒï¼Œä¸€èˆ¬é»˜è®¤ 4MB å¤§å°ã€‚ä¸‹å›¾æ˜¯ä¸€ä¸ªå¯¹è±¡çš„ç¤ºæ„å›¾ã€‚</p>\n<img src=\"/2022/10/22/Ceph%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E5%AF%B9%E8%B1%A1%E7%A4%BA%E6%84%8F%E5%9B%BE.png\" class=\"\" title=\"å¯¹è±¡ç¤ºæ„å›¾\">\n\n<p>ä¸€ä¸ªå¯¹è±¡ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p>\n<ol>\n<li>å¯¹è±¡æ ‡å¿—IDï¼›</li>\n<li>å¯¹è±¡çš„æ•°æ®ï¼Œå…¶åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯¹è±¡çš„æ•°æ®å°±ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼›</li>\n<li>å¯¹è±¡çš„å…ƒæ•°æ®ï¼Œä»¥key-valueå½¢å¼ä¿å­˜ã€‚</li>\n</ol>\n<h4 id=\"poolå’ŒPGçš„æ¦‚å¿µ\"><a href=\"#poolå’ŒPGçš„æ¦‚å¿µ\" class=\"headerlink\" title=\"poolå’ŒPGçš„æ¦‚å¿µ\"></a>poolå’ŒPGçš„æ¦‚å¿µ</h4><p>poolæ˜¯ä¸€ä¸ªæŠ½è±¡çš„å­˜å‚¨æ± ã€‚å®ƒè§„å®šäº†æ•°æ®å†—ä½™çš„ç±»å‹ä»¥åŠå¯¹åº”çš„å‰¯æœ¬åˆ†å¸ƒç­–ç•¥ï¼ˆå‰¯æœ¬ç±»å‹å’Œçº åˆ ç ç±»å‹ç­‰ï¼‰ã€‚ä¸€ä¸ªpoolç”±å¤šä¸ªPGæ„æˆã€‚</p>\n<p>PGï¼ˆplacement groupï¼‰æ˜¯ä¸€ä¸ªå¯¹è±¡çš„é›†åˆï¼Œè¯¥é›†åˆä¸­çš„æ‰€æœ‰å¯¹è±¡æœ‰ç›¸åŒçš„æ”¾ç½®ç­–ç•¥ï¼šå¯¹è±¡çš„å‰¯æœ¬éƒ½åˆ†å¸ƒåœ¨ç›¸åŒçš„OSDåˆ—è¡¨ä¸Šã€‚ä¸€ä¸ªå¯¹è±¡åªèƒ½å±äºä¸€ä¸ªPGï¼Œä¸€ä¸ªPGå¯¹åº”äºæ”¾ç½®åœ¨å…¶ä¸Šçš„OSDåˆ—è¡¨ã€‚ä¸€ä¸ªOSDä¸Šå¯ä»¥åˆ†å¸ƒå¤šä¸ªPGã€‚</p>\n<img src=\"/2022/10/22/Ceph%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/PG%E6%A6%82%E5%BF%B5%E7%A4%BA%E6%84%8F%E5%9B%BE.png\" class=\"\" title=\"PGæ¦‚å¿µç¤ºæ„å›¾\">\n\n<ol>\n<li>PG1å’ŒPG2éƒ½å±äºåŒä¸€ä¸ªpoolï¼Œéƒ½æ˜¯å‰¯æœ¬ç±»å‹ï¼Œä¸”éƒ½æ˜¯ä¸¤å‰¯æœ¬ï¼›</li>\n<li>PG1å’ŒPG2é‡ŒåŒ…å«è®¸å¤šå¯¹è±¡ï¼ŒPG1 ä¸Šçš„æ‰€æœ‰å¯¹è±¡ï¼Œä¸»ä»å‰¯æœ¬åˆ†å¸ƒåœ¨ 0SD1 å’Œ<br> 0SD2 ä¸Šï¼ŒPG2 ä¸Šçš„æ‰€æœ‰å¯¹è±¡çš„ä¸»ä»å‰¯æœ¬åˆ†å¸ƒåœ¨0SD2 å’Œ OSD3 ä¸Šï¼›</li>\n<li>ä¸€ä¸ªå¯¹è±¡åªèƒ½å±äºä¸€ä¸ªPGï¼Œä¸€ä¸ªPGåŒ…å«å¤šä¸ªå¯¹è±¡ï¼›</li>\n<li>ä¸€ä¸ª PG çš„å‰¯æœ¬åˆ†å¸ƒåœ¨å¯¹åº”çš„ OSD åˆ—è¡¨ä¸­ã€‚åœ¨ä¸€ä¸ª OSD ä¸Šå¯ä»¥åˆ†å¸ƒå¤šä¸ª PGã€‚ç¤ºä¾‹ä¸­ PG1 å’Œ PG2 çš„ä»å‰¯æœ¬éƒ½åˆ†å¸ƒåœ¨ 0SD2 ä¸Šã€‚</li>\n</ol>\n<h4 id=\"å¯¹è±¡å¯»å€è¿‡ç¨‹\"><a href=\"#å¯¹è±¡å¯»å€è¿‡ç¨‹\" class=\"headerlink\" title=\"å¯¹è±¡å¯»å€è¿‡ç¨‹\"></a>å¯¹è±¡å¯»å€è¿‡ç¨‹</h4><p>1</p>\n<h4 id=\"æ•°æ®è¯»å†™è¿‡ç¨‹\"><a href=\"#æ•°æ®è¯»å†™è¿‡ç¨‹\" class=\"headerlink\" title=\"æ•°æ®è¯»å†™è¿‡ç¨‹\"></a>æ•°æ®è¯»å†™è¿‡ç¨‹</h4><p>1</p>\n<h4 id=\"æ•°æ®å‡è¡¡\"><a href=\"#æ•°æ®å‡è¡¡\" class=\"headerlink\" title=\"æ•°æ®å‡è¡¡\"></a>æ•°æ®å‡è¡¡</h4><p>1</p>\n<h4 id=\"Peering\"><a href=\"#Peering\" class=\"headerlink\" title=\"Peering\"></a>Peering</h4><p>1</p>\n<h4 id=\"Recoveryå’ŒBackfill\"><a href=\"#Recoveryå’ŒBackfill\" class=\"headerlink\" title=\"Recoveryå’ŒBackfill\"></a>Recoveryå’ŒBackfill</h4><p>1</p>\n<h4 id=\"çº åˆ ç \"><a href=\"#çº åˆ ç \" class=\"headerlink\" title=\"çº åˆ ç \"></a>çº åˆ ç </h4><p>1</p>\n<h4 id=\"å¿«ç…§å’Œå…‹éš†\"><a href=\"#å¿«ç…§å’Œå…‹éš†\" class=\"headerlink\" title=\"å¿«ç…§å’Œå…‹éš†\"></a>å¿«ç…§å’Œå…‹éš†</h4><p>1</p>\n<h4 id=\"Cache-Tier\"><a href=\"#Cache-Tier\" class=\"headerlink\" title=\"Cache Tier\"></a>Cache Tier</h4><p>1</p>\n<h4 id=\"Scrub\"><a href=\"#Scrub\" class=\"headerlink\" title=\"Scrub\"></a>Scrub</h4><p>1</p>\n<h4 id=\"æœ¬ç« å°ç»“\"><a href=\"#æœ¬ç« å°ç»“\" class=\"headerlink\" title=\"æœ¬ç« å°ç»“\"></a>æœ¬ç« å°ç»“</h4><p>1</p>\n<h2 id=\"Cephé€šç”¨æ¨¡å—\"><a href=\"#Cephé€šç”¨æ¨¡å—\" class=\"headerlink\" title=\"Cephé€šç”¨æ¨¡å—\"></a>Cephé€šç”¨æ¨¡å—</h2><p>Cephæºä»£ç é€šç”¨åº“ä¸­çš„ä¸€äº›å…³é”®è€Œåˆå¤æ‚çš„æ•°æ®ç»“æ„ã€‚å¤§å¤šå®šä¹‰äº<code>src/common/</code>ä¸­</p>\n<ol>\n<li>Objectå’ŒBufferæ™®éä½¿ç”¨ï¼›</li>\n<li>çº¿ç¨‹æ± ThreadPoolå¯ä»¥æé«˜æ¶ˆæ¯å¤„ç†çš„å¹¶å‘èƒ½åŠ›ï¼›</li>\n<li>Finisheræä¾›å¼‚æ­¥æ“ä½œæ—¶æ¥æ‰§è¡Œå›è°ƒå‡½æ•°ï¼›</li>\n<li>Throttleåœ¨ç³»ç»Ÿçš„å„ä¸ªæ¨¡å—å„ä¸ªç¯èŠ‚éƒ½èƒ½çœ‹åˆ°ï¼Œç”¨æ¥é™åˆ¶ç³»ç»Ÿçš„è¯·æ±‚ï¼Œé¿å…ç¬æ—¶å¤§é‡è¯·æ±‚å¯¹ç³»ç»Ÿçš„å†²å‡»ï¼›</li>\n<li>SafteTimeræä¾›å®šæ—¶å™¨ï¼Œä¸ºè¶…æ—¶å’Œå®šæ—¶ä»»åŠ¡ç­‰æä¾›äº†ç›¸åº”çš„æœºåˆ¶ã€‚</li>\n</ol>\n<h3 id=\"Object\"><a href=\"#Object\" class=\"headerlink\" title=\"Object\"></a>Object</h3><p>å¯¹è±¡Objecté»˜è®¤ä¸º4MBå¤§å°çš„æ•°æ®å—ã€‚ä¸€ä¸ªå¯¹è±¡å¯¹åº”æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ–‡ä»¶ã€‚åœ¨ä»£ç å®ç°ä¸­ï¼Œæœ‰objectã€sobjectã€hobjectã€ghobjectç­‰ä¸åŒçš„ç±»ã€‚å¤§å¤šä½äº<code>src/include/object.h</code>ä¸­ã€‚</p>\n<h4 id=\"object-t\"><a href=\"#object-t\" class=\"headerlink\" title=\"object_t\"></a>object_t</h4><p>object_tå¯¹åº”æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œnameå°±æ˜¯å¯¹è±¡åã€‚</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">object_t</span>&#123;</span><br><span class=\"line\">\tstring name;</span><br><span class=\"line\">\t......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"sobject-t\"><a href=\"#sobject-t\" class=\"headerlink\" title=\"sobject_t\"></a>sobject_t</h4><p>sobject_tåœ¨object_tä¹‹ä¸Šå¢åŠ äº†snapshotä¿¡æ¯ï¼Œç”¨äºæ ‡è¯†æ˜¯å¦æ˜¯å¿«ç…§å¯¹è±¡ã€‚</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">sobject_t</span> &#123;</span><br><span class=\"line\">\t<span class=\"type\">object_t</span> oid;</span><br><span class=\"line\">\t<span class=\"type\">snapid_t</span> snap; <span class=\"comment\">// å¿«ç…§å¯¹è±¡çš„å¯¹åº”çš„å¿«ç…§åºå·ï¼›è‹¥ä¸æ˜¯å¿«ç…§å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯headå¯¹è±¡ï¼‰ï¼Œsnapå­—æ®µåˆ™ä¸ºCEPH_NOSNAPå€¼</span></span><br><span class=\"line\">\t......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"hobject-t\"><a href=\"#hobject-t\" class=\"headerlink\" title=\"hobject_t\"></a>hobject_t</h4><p>hobject_t æ˜¯ hash object çš„ç¼©å†™ã€‚ä½äº<code>src\\common\\hobject.h</code>ä¸­ã€‚</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">hobject_t</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"type\">object_t</span> oid;</span><br><span class=\"line\">    <span class=\"type\">snapid_t</span> snap;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span>:</span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> hash; <span class=\"comment\">// hashå’Œkeyä¸èƒ½åŒæ—¶è®¾ç½®ï¼Œhashå€¼ä¸€èˆ¬è®¾ä¸ºpgçš„idå€¼</span></span><br><span class=\"line\">    <span class=\"type\">bool</span> max;</span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> nibblewise_key_cache;</span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> hash_reverse_bits;</span><br><span class=\"line\">\t......</span><br><span class=\"line\">\t</span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"type\">int64_t</span> pool; <span class=\"comment\">// æ‰€åœ¨poolçš„id</span></span><br><span class=\"line\">    std::string nspace; <span class=\"comment\">// ä¸€èˆ¬ä¸ºç©ºï¼Œç”¨äºæ ‡è¯†ç‰¹æ®Šçš„å¯¹è±¡</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span>:</span><br><span class=\"line\">    std::string key; <span class=\"comment\">// å¯¹è±¡çš„ç‰¹æ®Šæ ‡è®°</span></span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"ghobject-t\"><a href=\"#ghobject-t\" class=\"headerlink\" title=\"ghobject_t\"></a>ghobject_t</h4><p>åœ¨hobject_tåŸºç¡€ä¸Šï¼Œæ·»åŠ generationå’Œshard_idå­—æ®µï¼Œç”¨äºçº åˆ ç æ¨¡å¼ä¸‹çš„PGã€‚</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">ghobject_t</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">static</span> <span class=\"type\">const</span> <span class=\"type\">gen_t</span> NO_GEN = UINT64_MAX;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">bool</span> max = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"type\">shard_id_t</span> shard_id = <span class=\"type\">shard_id_t</span>::NO_SHARD; <span class=\"comment\">// æ ‡è¯†å¯¹è±¡æ‰€åœ¨çš„OSDåœ¨çº åˆ ç ç±»å‹çš„PGä¸­çš„åºå·ï¼›å¦‚æœåœ¨å‰¯æœ¬ç±»å‹çš„PGä¸­ï¼Œé‚£ä¹ˆå­—æ®µå°±è®¾ç½®ä¸ºNO_SHARD(-1)</span></span><br><span class=\"line\">    <span class=\"type\">hobject_t</span> hobj;</span><br><span class=\"line\">    <span class=\"type\">gen_t</span> generation = NO_GEN; <span class=\"comment\">// è®°å½•å¯¹è±¡çš„ç‰ˆæœ¬å·ã€‚å½“PGä¸ºçº åˆ ç ç±»å‹æ—¶ï¼Œå†™æ“ä½œéœ€è¦åŒºåˆ«å†™å‰åä¸¤ä¸ªç‰ˆæœ¬çš„objectï¼Œæ­¤æ—¶è¯¥å­—æ®µä¿å­˜å¯¹è±¡çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œå½“å†™å¤±è´¥æ—¶ï¼Œå¯ä»¥rollbackåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬</span></span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Buffer\"><a href=\"#Buffer\" class=\"headerlink\" title=\"Buffer\"></a>Buffer</h3><p>bufferæ˜¯ä¸€ä¸ªå‘½åç©ºé—´ï¼Œé‡Œé¢å®šä¹‰äº†bufferç›¸å…³çš„æ•°æ®ç»“æ„ã€‚</p>\n<h4 id=\"buffer-raw\"><a href=\"#buffer-raw\" class=\"headerlink\" title=\"buffer::raw\"></a>buffer::raw</h4><p>ä½äº<code>src/include/buffer_raw.h</code>ä¸­ï¼Œæ˜¯ä¸€ä¸ªåŸºç±»ï¼Œå…¶å­ç±»å®Œæˆbufferæ•°æ®ç©ºé—´çš„åˆ†é…ã€‚</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ceph</span>::buffer::v15_2_0::raw&#123;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">\t<span class=\"type\">char</span> *data;  <span class=\"comment\">// æ•°æ®æŒ‡é’ˆ</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> len; <span class=\"comment\">// æ•°æ®é•¿åº¦</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\tceph::atomic&lt;<span class=\"type\">unsigned</span>&gt; nref&#123;<span class=\"number\">0</span>&#125;; <span class=\"comment\">// å¼•ç”¨è®¡æ•°</span></span><br><span class=\"line\">\tstd::aligned_storage&lt;<span class=\"built_in\">sizeof</span>(ptr_node),<span class=\"built_in\">alignof</span>(ptr_node)&gt;::type bptr_storage; <span class=\"comment\">// å¤§å°ä¸ºsizeof(ptr_node)ï¼Œalignof(ptr_node)å¯¹é½çš„ç±»å‹ã€‚ç”¨äºptr_nodeçš„æ„é€ (new placementæ–¹å¼)ï¼Œå®é™…å¹¶æœªä½¿ç”¨</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"comment\">// æŒ‡å®šæ•°æ®æ®µçš„æ ¡éªŒå€¼</span></span><br><span class=\"line\">    std::pair&lt;<span class=\"type\">size_t</span>, <span class=\"type\">size_t</span>&gt; last_crc_offset &#123;std::numeric_limits&lt;<span class=\"type\">size_t</span>&gt;::<span class=\"built_in\">max</span>(), std::numeric_limits&lt;<span class=\"type\">size_t</span>&gt;::<span class=\"built_in\">max</span>()&#125;;</span><br><span class=\"line\">    std::pair&lt;<span class=\"type\">uint32_t</span>, <span class=\"type\">uint32_t</span>&gt; last_crc_val;</span><br><span class=\"line\">\t<span class=\"keyword\">mutable</span> ceph::spinlock crc_spinlock; </span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ä¸‹åˆ—ç±»ç»§æ‰¿äº†<code>buffer::raw</code>ï¼Œå®ç°äº†dataå¯¹åº”å†…å­˜ç©ºé—´çš„ç”³è¯·ï¼Œå®šä¹‰äº<code>src/common/buffer.cc</code>ä¸­ï¼š</p>\n<ol>\n<li>class raw_combinedï¼šåˆ†é…çš„å¯¹è±¡äºdata bufferåˆ†é…åœ¨ä¸€ä¸ªbufferä¸Šï¼Œdataå¤„äºbufferçš„å¼€å¤´ï¼Œobjectä¸ºbufferå°¾ï¼›</li>\n<li>class raw_mallocï¼šå®ç°äº†ç”¨ malloc å‡½æ•°åˆ†é…å†…å­˜ç©ºé—´çš„åŠŸèƒ½ï¼›</li>\n<li>class buffer::raw_posix_alignedï¼šè°ƒç”¨äº†å‡½æ•° posix_memaligii æ¥ç”³è¯·å†…å­˜åœ°å€å¯¹é½<br> çš„å†…å­˜ç©ºé—´ï¼›</li>\n<li>class raw_staticï¼šdata bufferä½¿ç”¨static bufferï¼›</li>\n<li>class buffer::raw_hack_alignedï¼šåœ¨ç³»ç»Ÿä¸æ”¯æŒå†…å­˜å¯¹é½ç”³è¯·çš„æƒ…å†µä¸‹è‡ªå·±å®ç°<br> äº†å†…å­˜åœ°å€çš„å¯¹é½ï¼›</li>\n<li>class buffer::raw_charï¼šä½¿ç”¨äº† C++ çš„ new æ“ä½œç¬¦æ¥ç”³è¯·å†…å­˜ç©ºé—´ï¼› </li>\n<li>class buffer::raw_claimed_charï¼šä¸è´Ÿè´£é‡Šæ”¾èµ„æºï¼Œå› æ­¤å¯ä»¥æ˜¯å±€éƒ¨å˜é‡ã€‚é’ˆå¯¹newåˆ›å»ºçš„bufferï¼Œåˆ™éœ€æ‰‹åŠ¨æ˜¾ç¤ºé‡Šæ”¾ï¼›</li>\n<li>class buffer::raw_claim_bufferï¼šæ¥æ”¶è‡ªå®šä¹‰åˆ é™¤å™¨ã€‚</li>\n</ol>\n<h4 id=\"buffer-ptr\"><a href=\"#buffer-ptr\" class=\"headerlink\" title=\"buffer::ptr\"></a>buffer::ptr</h4><p>æ˜¯å¯¹äºbuffer::rawçš„ä¸€ä¸ªéƒ¨åˆ†æ•°æ®æ®µï¼Œå®šä¹‰äº<code>src/include/buffer.h</code>ä¸­ã€‚</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">CEPH_BUFFER_API</span> ptr&#123;</span><br><span class=\"line\">    raw *_raw;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> _off, _len; <span class=\"comment\">// èµ·å§‹åç§»é‡ï¼Œé•¿åº¦</span></span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/2022/10/22/Ceph%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/raw%E5%92%8Cptr%E7%A4%BA%E6%84%8F%E5%9B%BE.png\" class=\"\" title=\"rawå’Œptrç¤ºæ„å›¾\">\n\n<h4 id=\"buffer-list\"><a href=\"#buffer-list\" class=\"headerlink\" title=\"buffer::list\"></a>buffer::list</h4><p>æ˜¯å¤šä¸ªbuffer::ptrçš„åˆ—è¡¨ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªå†…å­˜æ•°æ®æ®µçš„åˆ—è¡¨ï¼Œå®šä¹‰äº<code>src/include/buffer.h</code>ã€‚</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">CEPH_BUFFER_API</span> list&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"keyword\">class</span> <span class=\"title class_\">buffers_t</span>&#123; <span class=\"comment\">// åº•å±‚å•é“¾è¡¨å®ç°</span></span><br><span class=\"line\">\t\tptr_hook _root;</span><br><span class=\"line\">\t\tptr_hook *_tail;</span><br><span class=\"line\">\t\t......</span><br><span class=\"line\">            </span><br><span class=\"line\">        <span class=\"comment\">// æ·»åŠ åˆ°å¤´éƒ¨</span></span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">push_front</span><span class=\"params\">(reference item)</span> </span>&#123;</span><br><span class=\"line\">            item.next = _root.next;</span><br><span class=\"line\">            _root.next = &amp;item;</span><br><span class=\"line\">            _tail = _tail == &amp;_root ? &amp;item : _tail;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\t<span class=\"type\">buffers_t</span> _buffers; <span class=\"comment\">// è‡ªå·±çš„ç§æœ‰bits</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> _len;</span><br><span class=\"line\">\t......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>ï¼ˆlistç»“æ„å¤§æ”¹ï¼Œè¿˜éœ€è¦ä»”ç»†é˜…è¯»åŸä¹¦å’Œæºç </strong></p>\n<h3 id=\"çº¿ç¨‹æ± \"><a href=\"#çº¿ç¨‹æ± \" class=\"headerlink\" title=\"çº¿ç¨‹æ± \"></a>çº¿ç¨‹æ± </h3><p>ThreadPoolå®šä¹‰äº<code>src/common/WorkQueue.h</code>ä¸­ã€‚</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ThreadPool</span> : <span class=\"keyword\">public</span> <span class=\"type\">md_config_obs_t</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">\tCephContext *cct;</span><br><span class=\"line\">  \tstd::string name; \t\t\t\t\t\t<span class=\"comment\">// çº¿ç¨‹åï¼Ÿ</span></span><br><span class=\"line\">  \tstd::string thread_name; </span><br><span class=\"line\">  \tstd::string lockname; \t\t\t\t\t<span class=\"comment\">// é”å</span></span><br><span class=\"line\">  \tceph::mutex _lock; \t\t\t\t\t\t<span class=\"comment\">// çº¿ç¨‹äº’æ–¥é”ï¼Œä¹Ÿæ˜¯å·¥ä½œé˜Ÿåˆ—è®¿é—®äº’æ–¥çš„é”</span></span><br><span class=\"line\">  \tceph::condition_variable _cond;\t\t\t<span class=\"comment\">// é”å¯¹åº”çš„æ¡ä»¶å˜é‡</span></span><br><span class=\"line\">  \t<span class=\"type\">bool</span> _stop; \t\t\t\t\t\t\t<span class=\"comment\">// çº¿ç¨‹æ± æ˜¯å¦åœæ­¢å·¥ä½œçš„æ ‡å¿—</span></span><br><span class=\"line\">  \t<span class=\"type\">int</span> _pause; \t\t\t\t\t\t\t<span class=\"comment\">// æš‚åœä¸­æ­¢çº¿ç¨‹æ± çš„æ ‡å¿—</span></span><br><span class=\"line\">  \t<span class=\"type\">int</span> _draining;</span><br><span class=\"line\"> \tceph::condition_variable _wait_cond;</span><br><span class=\"line\">    </span><br><span class=\"line\">    std::vector&lt;WorkQueue_*&gt; work_queues; \t<span class=\"comment\">// å·¥ä½œé˜Ÿåˆ—[é›†å’Œ]</span></span><br><span class=\"line\">    <span class=\"type\">int</span> next_work_queue = <span class=\"number\">0</span>;\t\t\t\t<span class=\"comment\">// ä¸‹ä¸€æ¬¡è®¿é—®çš„å·¥ä½œé˜Ÿåˆ—</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    std::set&lt;WorkThread*&gt; _threads;\t\t\t<span class=\"comment\">// çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹</span></span><br><span class=\"line\">    std::list&lt;WorkThread*&gt; _old_threads;  \t<span class=\"comment\">// ç­‰å¾…è¿›joinedæ“ä½œçš„çº¿ç¨‹</span></span><br><span class=\"line\">  \t<span class=\"type\">int</span> processing;</span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—å¯¹åº”ä¸€ä¸ªç±»å‹çš„åå°å¤„ç†ä»»åŠ¡ï¼Œä¸€ä¸ªçº¿ç¨‹æ± å¯¹åº”ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼Œä¸“é—¨ç”¨äºå¤„ç†è¯¥ç±»å‹çš„ä»»åŠ¡ã€‚å¦‚æœæ˜¯åå°ä»»åŠ¡ï¼Œåˆä¸ç´§æ€¥ï¼Œå°±å¯ä»¥å°†å¤šä¸ªå·¥ä½œé˜Ÿåˆ—æ”¾ç½®åˆ°ä¸€ä¸ªçº¿ç¨‹æ± ä¸­ï¼Œè¯¥çº¿ç¨‹æ± å¯ä»¥å¤„ç†ä¸åŒç±»å‹çš„ä»»åŠ¡ã€‚</p>\n<p>çº¿ç¨‹æ± çš„å®ç°ä¸»è¦åŒ…æ‹¬ï¼š</p>\n<ol>\n<li>çº¿ç¨‹æ± çš„å¯åŠ¨è¿‡ç¨‹ï¼›</li>\n<li>çº¿ç¨‹æ± å¯¹åº”çš„å·¥ä½œé˜Ÿåˆ—ç®¡ç†ï¼›</li>\n<li>çº¿ç¨‹æ± å¯¹åº”çš„æ‰§è¡Œå‡½æ•°å¦‚ä½•æ‰§è¡Œä»»åŠ¡ã€‚</li>\n</ol>\n<h4 id=\"çº¿ç¨‹æ± çš„å¯åŠ¨\"><a href=\"#çº¿ç¨‹æ± çš„å¯åŠ¨\" class=\"headerlink\" title=\"çº¿ç¨‹æ± çš„å¯åŠ¨\"></a>çº¿ç¨‹æ± çš„å¯åŠ¨</h4><p>ThreadPool::start()ç”¨æ¥å¯åŠ¨çº¿ç¨‹æ± ï¼Œå…¶åœ¨åŠ é”çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨å‡½æ•° start_threadsï¼Œè¯¥å‡½æ•°æ£€æŸ»å½“å‰çº¿ç¨‹æ•°ï¼Œå¦‚æœå°äºé…ç½®çš„çº¿ç¨‹æ± ï¼Œå°±åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ã€‚å®šä¹‰äº<code>src/common/WorkQueue.cc</code>ã€‚</p>\n<h4 id=\"å·¥ä½œé˜Ÿåˆ—\"><a href=\"#å·¥ä½œé˜Ÿåˆ—\" class=\"headerlink\" title=\"å·¥ä½œé˜Ÿåˆ—\"></a>å·¥ä½œé˜Ÿåˆ—</h4><p>å·¥ä½œé˜Ÿåˆ—ï¼ˆWorkQueue) å®šä¹‰äº†çº¿ç¨‹æ± è¦å¤„ç†çš„ä»»åŠ¡ã€‚</p>\n<ol>\n<li>ä»»åŠ¡ç±»å‹åœ¨æ¨¡æ¿å‚æ•°ä¸­æŒ‡å®šï¼›</li>\n<li>åœ¨æ„é€ å‡½æ•°é‡Œï¼Œå°±æŠŠè‡ªå·±åŠ å…¥åˆ°çº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—é›†åˆä¸­ï¼›</li>\n<li>WorkQueueå®ç°äº†éƒ¨åˆ†åŠŸèƒ½ï¼šè¿›é˜Ÿåˆ—ã€å‡ºé˜Ÿåˆ—ã€åŠ é”ï¼›</li>\n<li>éƒ¨åˆ†åŠŸèƒ½éœ€è¦ä½¿ç”¨è€…å®šä¹‰ï¼Œå¦‚å®šä¹‰ä¿å­˜ä»»åŠ¡çš„å®¹å™¨ï¼Œæ·»åŠ å’Œåˆ é™¤çš„æ–¹æ³•ï¼Œä»¥åŠå¦‚ä½•å¤„ç†ä»»åŠ¡çš„æ–¹æ³•ã€‚</li>\n</ol>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">class</span> <span class=\"title class_\">T</span>&gt;</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">WorkQueue</span> : <span class=\"keyword\">public</span> WorkQueue_ &#123;</span><br><span class=\"line\">    ThreadPool *pool;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// Add a work item to the queue.</span></span><br><span class=\"line\">    <span class=\"keyword\">virtual</span> <span class=\"type\">bool</span> _enqueue(T *) = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"comment\">// Dequeue a previously submitted work item.</span></span><br><span class=\"line\">    <span class=\"keyword\">virtual</span> <span class=\"type\">void</span> _dequeue(T *) = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"comment\">// Dequeue a work item and return the original submitted pointer.</span></span><br><span class=\"line\">    <span class=\"keyword\">virtual</span> T *_dequeue() = <span class=\"number\">0</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    <span class=\"comment\">// Process a work item. Called from the worker threads.</span></span><br><span class=\"line\">    <span class=\"keyword\">virtual</span> <span class=\"type\">void</span> _process(T *t, TPHandle &amp;) = <span class=\"number\">0</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"built_in\">WorkQueue</span>(std::string n,</span><br><span class=\"line\">\t    \tceph::timespan ti, ceph::timespan sti,</span><br><span class=\"line\">\t    \tThreadPool* p)</span><br><span class=\"line\">      \t\t: <span class=\"built_in\">WorkQueue_</span>(std::<span class=\"built_in\">move</span>(n), ti, sti), <span class=\"built_in\">pool</span>(p) &#123;</span><br><span class=\"line\">      \tpool-&gt;<span class=\"built_in\">add_work_queue</span>(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">queue</span><span class=\"params\">(T *item)</span> </span>&#123; <span class=\"comment\">// è¿›é˜Ÿåˆ—</span></span><br><span class=\"line\">     \tpool-&gt;_lock.<span class=\"built_in\">lock</span>();</span><br><span class=\"line\">     \t<span class=\"type\">bool</span> r = _enqueue(item);</span><br><span class=\"line\">     \tpool-&gt;_cond.<span class=\"built_in\">notify_one</span>();</span><br><span class=\"line\">     \tpool-&gt;_lock.<span class=\"built_in\">unlock</span>();</span><br><span class=\"line\">    \t<span class=\"keyword\">return</span> r;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">dequeue</span><span class=\"params\">(T *item)</span> </span>&#123; <span class=\"comment\">// å‡ºé˜Ÿåˆ—</span></span><br><span class=\"line\">      \tpool-&gt;_lock.<span class=\"built_in\">lock</span>();</span><br><span class=\"line\">      \t_dequeue(item);</span><br><span class=\"line\">      \tpool-&gt;_lock.<span class=\"built_in\">unlock</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">      \tpool-&gt;_lock.<span class=\"built_in\">lock</span>();</span><br><span class=\"line\">      \t_clear();</span><br><span class=\"line\">      \tpool-&gt;_lock.<span class=\"built_in\">unlock</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">lock</span><span class=\"params\">()</span> </span>&#123; pool-&gt;<span class=\"built_in\">lock</span>(); &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">unlock</span><span class=\"params\">()</span> </span>&#123; pool-&gt;<span class=\"built_in\">unlock</span>(); &#125;</span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"çº¿ç¨‹æ± çš„æ‰§è¡Œå‡½æ•°\"><a href=\"#çº¿ç¨‹æ± çš„æ‰§è¡Œå‡½æ•°\" class=\"headerlink\" title=\"çº¿ç¨‹æ± çš„æ‰§è¡Œå‡½æ•°\"></a>çº¿ç¨‹æ± çš„æ‰§è¡Œå‡½æ•°</h4><p>ThreadPool::workerå®šä¹‰äº<code>src/common/WorkQueue.cc</code>ä¸­ã€‚</p>\n<ol>\n<li>é¦–å…ˆæ£€æŸ¥_stopæ ‡å¿—ï¼Œç¡®ä¿çº¿ç¨‹æ± æ²¡æœ‰å…³é—­ï¼›</li>\n<li>è°ƒç”¨å‡½æ•°join_old_threadsæŠŠæ—§çš„å·¥ä½œçº¿ç¨‹é‡Šæ”¾æ‰ã€‚æ£€æŸ»å¦‚æœçº¿ç¨‹æ•°é‡å¤§äºé…ç½®çš„æ•°é‡ _num_threadsï¼Œå°±æŠŠå½“å‰çº¿ç¨‹ä»çº¿ç¨‹é›†åˆä¸­åˆ é™¤ï¼Œå¹¶åŠ å…¥_old_threadsé˜Ÿåˆ—ä¸­ï¼Œå¹¶é€€<br> å‡ºå¾ªç¯ï¼›</li>\n<li>å¦‚æœçº¿ç¨‹æ± æ²¡æœ‰ä¸­æ­¢ï¼ˆ_pauseï¼‰ä¸”work_queuesä¸ä¸ºç©ºï¼Œå°±ä»next_work_queueå¼€å§‹ï¼Œè¾¹ç†æ¯ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼Œå¦‚æœå·¥ä½œä¼šè£‚ä¸ä¸ºç©ºï¼Œå°±å–å‡ºä¸€ä¸ªitemï¼Œè°ƒç”¨å·¥ä½œé˜Ÿåˆ—çš„å¤„ç†å‡½æ•°åšå¤„ç†ã€‚</li>\n</ol>\n<h4 id=\"è¶…æ—¶æ£€æŸ¥\"><a href=\"#è¶…æ—¶æ£€æŸ¥\" class=\"headerlink\" title=\"è¶…æ—¶æ£€æŸ¥\"></a>è¶…æ—¶æ£€æŸ¥</h4><p>TPHandleæ˜¯ä¸€ä¸ªæœ‰æ„æ€çš„äº‹æƒ…ï¼Œå®šä¹‰äº<code>src/common/WorkerQueue.h</code>ä¸­ã€‚æ¯æ¬¡çº¿ç¨‹å‡½æ•°æ‰§è¡Œæ—¶ï¼Œéƒ½ä¼šè®¾ç½®ä¸€ä¸ª grace è¶…æ—¶æ—¶é—´ï¼Œå½“çº¿ç¨‹æ‰§è¡Œè¶…è¿‡è¯¥æ—¶é—´ï¼Œå°±è®¤ä¸ºæ˜¯ unhealthy çš„çŠ¶æ€ã€‚å½“æ‰§è¡Œæ—¶é—´è¶…è¿‡ suicide_grace æ—¶ï¼ŒOSD å°±ä¼šäº§ç”Ÿæ–­è¨€è€Œå¯¼è‡´è‡ªæ€ï¼Œä»£ç å¦‚ä¸‹ï¼š  </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ThreadPool</span>::TPHandle : <span class=\"keyword\">public</span> HBHandle &#123;</span><br><span class=\"line\">        <span class=\"keyword\">friend</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ThreadPool</span>;</span><br><span class=\"line\">        CephContext *cct;\t\t\t\t</span><br><span class=\"line\">        ceph::heartbeat_handle_d *hb;\t<span class=\"comment\">// å¿ƒè·³</span></span><br><span class=\"line\">        ceph::timespan grace;\t\t\t<span class=\"comment\">// è¶…æ—¶</span></span><br><span class=\"line\">        ceph::timespan suicide_grace;\t<span class=\"comment\">// è‡ªæ€çš„è¶…æ—¶æ—¶é—´</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">public</span>:</span><br><span class=\"line\">        <span class=\"built_in\">TPHandle</span>(CephContext *cct, ceph::heartbeat_handle_d *hb,</span><br><span class=\"line\">                 ceph::timespan grace, ceph::timespan suicide_grace)</span><br><span class=\"line\">            : <span class=\"built_in\">cct</span>(cct), <span class=\"built_in\">hb</span>(hb), <span class=\"built_in\">grace</span>(grace), <span class=\"built_in\">suicide_grace</span>(suicide_grace) &#123;&#125;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">reset_tp_timeout</span><span class=\"params\">()</span> <span class=\"keyword\">override</span> <span class=\"keyword\">final</span></span>;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">suspend_tp_timeout</span><span class=\"params\">()</span> <span class=\"keyword\">override</span> <span class=\"keyword\">final</span></span>;</span><br><span class=\"line\">    ......</span><br><span class=\"line\">    &#125;;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"ShardedThreadPool\"><a href=\"#ShardedThreadPool\" class=\"headerlink\" title=\"ShardedThreadPool\"></a>ShardedThreadPool</h4><p>ThreadPool å®ç°çš„çº¿ç¨‹æ± ï¼Œå…¶æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰æœºä¼šå¤„ç†å·¥ä½œé˜Ÿåˆ—çš„ä»»æ„ä¸€ä¸ªä»»åŠ¡ã€‚è¿™å°±ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœä»»åŠ¡ä¹‹é—´æœ‰äº’æ–¥æ€§ï¼Œé‚£ä¹ˆæ­£åœ¨å¤„ç†è¯¥ä»»åŠ¡çš„ä¸¤ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªå¤„ç†å®Œæˆåæ‰èƒ½å¤„ç†ï¼Œä»è€Œå¯¼è‡´çº¿ç¨‹çš„é˜»å¡ï¼Œæ€§èƒ½ä¸‹é™ã€‚</p>\n<p>å…·ä½“å¦‚ä½•å®ç° Shard æ–¹å¼ï¼Œè¿˜éœ€è¦ä½¿ç”¨è€…è‡ªå·±å»å®ç°ã€‚å…¶åŸºæœ¬çš„æ€æƒ³å°±æ˜¯ï¼šæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰€æœ‰éœ€è¦é¡ºåºæ‰§è¡Œçš„ä»»åŠ¡éƒ½æ”¾åœ¨åŒä¸€ä¸ªçº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—é‡Œï¼Œå…¨éƒ¨ç”±è¯¥çº¿ç¨‹æ‰§è¡Œã€‚ å®šä¹‰äº<code>src/common/WorkerQueue.h</code>ä¸­ </p>\n<h3 id=\"Finisher\"><a href=\"#Finisher\" class=\"headerlink\" title=\"Finisher\"></a>Finisher</h3><p>ç±»Finisherç”¨æ¥å®Œæˆå›è°ƒå‡½æ•°Contextçš„æ‰§è¡Œï¼Œå…¶å†…éƒ¨æœ‰ä¸€ä¸ªFinisherThreadçº¿ç¨‹æ¥ç”¨äºæ‰§è¡ŒContextå›è°ƒå‡½æ•°ã€‚å®šä¹‰äº<code>src/common/Finisher.h</code>ä¸­ã€‚</p>\n<h3 id=\"Throttle\"><a href=\"#Throttle\" class=\"headerlink\" title=\"Throttle\"></a>Throttle</h3><p>ç±»Throttleç”¨æ¥é™åˆ¶æ¶ˆè´¹çš„èµ„æºæ•°é‡ï¼ˆä¹Ÿå¸¸ç§°ä¸ºæ§½ä½ â€œslotâ€ï¼‰ï¼Œå½“è¯·æ±‚çš„ slot æ•°é‡è¾¾åˆ°maxå€¼æ—¶ï¼Œè¯·æ±‚å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æœ‰æ–°çš„æ§½ä½é‡Šæ”¾å‡ºæ¥ï¼Œå®šä¹‰äº<code>src/common/Throttle.h</code>ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Throttle</span> <span class=\"keyword\">final</span> : <span class=\"keyword\">public</span> ThrottleInterface &#123;</span><br><span class=\"line\">  \tCephContext *cct;</span><br><span class=\"line\">  \t<span class=\"type\">const</span> std::string name;</span><br><span class=\"line\">  \tPerfCountersRef logger;</span><br><span class=\"line\">  \tstd::atomic&lt;<span class=\"type\">int64_t</span>&gt; count = &#123; <span class=\"number\">0</span> &#125;, max = &#123; <span class=\"number\">0</span> &#125;;  \t<span class=\"comment\">// å½“å‰å ç”¨çš„slotæ•°é‡å’Œslotæ•°é‡çš„æœ€å¤§å€¼</span></span><br><span class=\"line\">  \tstd::mutex lock;\t\t\t\t\t\t\t\t\t<span class=\"comment\">// ç­‰å¾…çš„é”</span></span><br><span class=\"line\">  \tstd::list&lt;std::condition_variable&gt; conds;\t\t\t<span class=\"comment\">// ç­‰å¾…çš„æ¡ä»¶å˜é‡</span></span><br><span class=\"line\">    ......</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">get</span><span class=\"params\">(<span class=\"type\">int64_t</span> c = <span class=\"number\">1</span>, <span class=\"type\">int64_t</span> m = <span class=\"number\">0</span>)</span></span>;\t\t\t\t<span class=\"comment\">// è·å–cä¸ªslotï¼Œå¦‚æœmä¸ä¸º0å€¼ï¼Œåˆ™å°†maxè®¾ç½®ä¸ºmçš„å€¼ï¼›æˆåŠŸè·å–cä¸ªslotåï¼Œå°±è¿”å›trueï¼Œå¦åˆ™é˜»å¡ç­‰å¾…</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">get_or_fail</span><span class=\"params\">(<span class=\"type\">int64_t</span> c = <span class=\"number\">1</span>)</span></span>;\t\t\t\t\t<span class=\"comment\">// å½“è·å–ä¸åˆ°cä¸ªslotæ—¶ï¼Œç›´æ¥è¿”å›falseï¼Œä¸é˜»å¡ç­‰å¾…</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">int64_t</span> <span class=\"title\">put</span><span class=\"params\">(<span class=\"type\">int64_t</span> c = <span class=\"number\">1</span>)</span> <span class=\"keyword\">override</span></span>;\t\t\t\t<span class=\"comment\">// é‡Šæ”¾cä¸ªslotèµ„æº</span></span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"SafeTimer\"><a href=\"#SafeTimer\" class=\"headerlink\" title=\"SafeTimer\"></a>SafeTimer</h3><p>ç±»SafeTimerå®ç°äº†å®šæ—¶å™¨çš„åŠŸèƒ½ï¼Œå®šä¹‰äº<code>src/common/Timer.h</code>ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">template</span> &lt;<span class=\"keyword\">class</span> <span class=\"title class_\">Mutex</span>&gt; <span class=\"keyword\">class</span> <span class=\"title class_\">CommonSafeTimer</span> &#123;</span><br><span class=\"line\">    CephContext *cct;</span><br><span class=\"line\">    Mutex &amp;lock;</span><br><span class=\"line\">    std::condition_variable_any cond;</span><br><span class=\"line\">    <span class=\"type\">bool</span> safe_callbacks;\t\t\t\t\t\t\t<span class=\"comment\">// æ˜¯å¦æ˜¯safe_callbacks</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">friend</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CommonSafeTimerThread</span>&lt;Mutex&gt;;</span><br><span class=\"line\">    <span class=\"keyword\">class</span> <span class=\"title class_\">CommonSafeTimerThread</span>&lt;Mutex&gt; *thread;\t\t<span class=\"comment\">// å®šæ—¶å™¨æ‰§è¡Œçº¿ç¨‹</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">using</span> <span class=\"type\">clock_t</span> = ceph::mono_clock;</span><br><span class=\"line\">    <span class=\"keyword\">using</span> <span class=\"type\">scheduled_map_t</span> = std::multimap&lt;<span class=\"type\">clock_t</span>::time_point, Context *&gt;;</span><br><span class=\"line\">    <span class=\"type\">scheduled_map_t</span> schedule;\t<span class=\"comment\">// ç›®æ ‡æ—¶é—´å’Œå®šæ—¶ä»»åŠ¡æ‰§è¡Œå‡½æ•°Context</span></span><br><span class=\"line\">    <span class=\"keyword\">using</span> <span class=\"type\">event_lookup_map_t</span> = std::map&lt;Context *, <span class=\"type\">scheduled_map_t</span>::iterator&gt;;</span><br><span class=\"line\">    <span class=\"type\">event_lookup_map_t</span> events;\t<span class=\"comment\">// å®šæ—¶ä»»åŠ¡&lt;--&gt;å®šæ—¶ä»»åŠ¡åœ¨scheduleä¸­çš„ä½ç½®æ˜ å°„</span></span><br><span class=\"line\">    <span class=\"type\">bool</span> stopping;\t\t\t\t<span class=\"comment\">// æ˜¯å¦åœæ­¢</span></span><br><span class=\"line\">    ......</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"comment\">// æ·»åŠ å®šæ—¶ä»»åŠ¡</span></span><br><span class=\"line\">    <span class=\"function\">Context *<span class=\"title\">add_event_after</span><span class=\"params\">(ceph::timespan duration, Context *callback)</span></span>;</span><br><span class=\"line\">    <span class=\"function\">Context *<span class=\"title\">add_event_after</span><span class=\"params\">(<span class=\"type\">double</span> seconds, Context *callback)</span></span>;</span><br><span class=\"line\">    <span class=\"function\">Context *<span class=\"title\">add_event_at</span><span class=\"params\">(<span class=\"type\">clock_t</span>::time_point when, Context *callback)</span></span>;</span><br><span class=\"line\">    <span class=\"function\">Context *<span class=\"title\">add_event_at</span><span class=\"params\">(ceph::real_clock::time_point when, Context *callback)</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// å–æ¶ˆå®šæ—¶ä»»åŠ¡</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">cancel_event</span><span class=\"params\">(Context *callback)</span></span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">cancel_all_events</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// å®šæ—¶ä»»åŠ¡æ‰§è¡Œ</span></span><br><span class=\"line\">    <span class=\"comment\">/* å¾ªç¯æ£€æŸ¥scheduleä¸­çš„ä»»åŠ¡æ˜¯å¦åˆ°æœŸï¼Œç”±äºscheduleä¸­æ˜¯æŒ‰ç…§æ—¶é—´å‡åºæ’åˆ—çš„ï¼Œå› æ­¤ç¬¬ä¸€ä»»åŠ¡æ²¡æœ‰åˆ°æœŸå°±ç»ˆæ­¢å¾ªç¯ï¼›</span></span><br><span class=\"line\"><span class=\"comment\">       å¦‚æœç¬¬ä¸€ä»»åŠ¡åˆ°æœŸï¼Œåˆ™è°ƒç”¨callbackæ‰§è¡Œï¼Œéœ€è¦æ³¨æ„å¦‚æœæ˜¯ésafe_callbacksï¼Œåˆ™éœ€è¦å…ˆè·å–lockå†æ‰§è¡Œcallbackå‡½æ•°ã€‚*/</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">timer_thread</span><span class=\"params\">()</span></span>; </span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">using</span> SafeTimer = <span class=\"keyword\">class</span> CommonSafeTimer&lt;ceph::mutex&gt;;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Cephç½‘ç»œé€šä¿¡\"><a href=\"#Cephç½‘ç»œé€šä¿¡\" class=\"headerlink\" title=\"Cephç½‘ç»œé€šä¿¡\"></a>Cephç½‘ç»œé€šä¿¡</h2><p>æœ¬ç« ä»‹ç» Ceph ç½‘ç»œé€šä¿¡æ¨¡å—ï¼Œè¿™æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šä¿¡çš„åº•å±‚æ¨¡å—ï¼Œç”¨æ¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´æ¥æ”¶å’Œå‘é€è¯·æ±‚ã€‚å…¶å®ç°åŠŸèƒ½æ¯”è¾ƒæ¸…æ™°ï¼Œæ˜¯ä¸€ä¸ªç›¸å¯¹è¾ƒç‹¬ç«‹çš„æ¨¡å—ç†è§£èµ·æ¥æ¯”è¾ƒå®¹æ˜“ï¼Œæ‰€ä»¥é¦–å…ˆä»‹ç»å®ƒã€‚  </p>\n<h3 id=\"Cephç½‘ç»œé€šä¿¡æ¡†æ¶\"><a href=\"#Cephç½‘ç»œé€šä¿¡æ¡†æ¶\" class=\"headerlink\" title=\"Cephç½‘ç»œé€šä¿¡æ¡†æ¶\"></a>Cephç½‘ç»œé€šä¿¡æ¡†æ¶</h3><p>â€”ä¸ªåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿéœ€è¦ä¸€ä¸ªç¨³å®šçš„åº•å±‚ç½‘ç»œé€šä¿¡æ¨¡å—ï¼Œç”¨äºå„èŠ‚ç‚¹ä¹‹é—´çš„äº’è”äº’é€šã€‚å¯¹äºä¸€ä¸ªç½‘ç»œé€šä¿¡ç³»ç»Ÿï¼Œè¦æ±‚å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>é«˜æ€§èƒ½ï¼šå¸¦å®½å’Œå»¶æ—¶ï¼›</li>\n<li>ç¨³å®šå¯é ï¼šæ•°æ®ä¸ä¸¢åŒ…ï¼Œåœ¨ç½‘ç»œä¸­æ–­æ—¶ï¼Œå®ç°é‡è¿ç­‰å¼‚å¸¸å¤„ç†ã€‚</li>\n</ol>\n<p>ç½‘ç»œé€šä¿¡æ¨¡å—çš„å®ç°åœ¨æºä»£ç <code>src/msg</code>çš„ç›®å½•ä¸‹ï¼Œå…¶é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªç½‘ç»œé€šä¿¡çš„æ¡†æ¶ï¼Œä¸‰ä¸ªå­ç›®å½•é‡Œåˆ†åˆ«å¯¹åº”ï¼šSimpleã€Asyncã€XIOä¸‰ç§ä¸åŒçš„å®ç°æ–¹å¼ã€‚</p>\n<p>Simple æ˜¯æ¯”è¾ƒç®€å•ï¼Œç›®å‰æ¯”è¾ƒç¨³å®šçš„å®ç°ï¼Œç³»ç»Ÿé»˜è®¤çš„ç”¨äºç”Ÿäº§ç¯å¢ƒçš„æ–¹å¼ã€‚å®ƒæœ€å¤§çš„ç‰¹ç‚¹æ˜¯ï¼šæ¯ä¸€ä¸ªç½‘ç»œé“¾æ¥ï¼Œéƒ½ä¼šåˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªä¸“é—¨ç”¨äºæ¥æ”¶ï¼Œä¸€ä¸ªä¸“é—¨ç”¨äºå‘é€ã€‚è¿™ç§æ¨¡å¼å®ç°æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å¯¹äºå¤§è§„æ¨¡çš„é›†ç¾¤éƒ¨ç½²ï¼Œå¤§é‡çš„é“¾æ¥ä¼šäº§ç”Ÿå¤§é‡çš„çº¿ç¨‹ï¼Œä¼šæ¶ˆè€— CPU èµ„æºï¼Œå½±å“æ€§èƒ½ã€‚   </p>\n<p>Async æ¨¡å¼ä½¿ç”¨äº†åŸºäºäº‹ä»¶çš„ I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å¼ã€‚è¿™æ˜¯ç›®å‰ç½‘ç»œé€šä¿¡ä¸­å¹¿æ³›é‡‡ç”¨çš„æ–¹å¼ï¼Œ ä½†æ˜¯åœ¨ Ceph ä¸­ï¼Œå®˜æ–¹å®£ç§°è¿™ç§æ–¹å¼è¿˜å¤„äºè¯•éªŒé˜¶æ®µï¼Œä¸å¤Ÿç¨³å®šï¼Œè¿˜ä¸èƒ½ç”¨äºç”Ÿäº§ç¯å¢ƒï¼ˆğŸ“•ä¸­çš„Cephæ˜¯10.2.1è€ç‰ˆæœ¬ï¼Œ<strong>æ–°ç‰ˆæœ¬ä¸­ä¼¼ä¹åªæœ‰Asyncæ¨¡å¼äº†</strong>ï¼‰ã€‚</p>\n<p>XIO æ–¹å¼ä½¿ç”¨äº†å¼€æºçš„ç½‘ç»œé€šä¿¡åº“ accelio æ¥å®ç°ã€‚è¿™ç§æ–¹å¼éœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹çš„åº“ accelio ç¨³å®šæ€§ï¼Œ éœ€è¦å¯¹ accelio çš„ä½¿ç”¨æ–¹å¼ä»¥åŠä»£ç å®ç°éƒ½æ¯”è¾ƒç†Ÿæ‚‰ã€‚ç›®å‰ä¹Ÿå¤„äºè¯•éªŒé˜¶æ®µã€‚ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œ å‰ä¸¤ç§æ–¹å¼åªæ”¯æŒ TCP&#x2F;IP åè®®ï¼ŒXIO å¯ä»¥æ”¯æŒ Infiniband ç½‘ç»œã€‚</p>\n<p>åœ¨ msg ç›®å½•ä¸‹å®šä¹‰äº†ç½‘ç»œé€šä¿¡çš„æŠ½è±¡æ¡†æ¶ï¼Œå®ƒå®Œæˆäº†é€šä¿¡æ¥å£å’Œå…·ä½“å®ç°çš„åˆ†ç¦»ã€‚åœ¨å…¶ä¸‹åˆ†åˆ«æœ‰ <code>msg/simple</code> å­ç›®å½•ã€ <code>msg/Async</code> å­ç›®å½•ã€ <code>msg/xio</code> å­ç›®å½•ï¼Œåˆ†åˆ«å¯¹åº”ä¸‰ç§ä¸åŒçš„å®ç°ã€‚ </p>\n<h4 id=\"Message\"><a href=\"#Message\" class=\"headerlink\" title=\"Message\"></a>Message</h4><p>ç±»Messageæ˜¯æ‰€æœ‰æ¶ˆæ¯çš„åŸºç±»ï¼Œä»»ä½•è¦å‘é€çš„æ¶ˆæ¯ï¼Œéƒ½è¦ç»§æ‰¿è¯¥ç±»ï¼Œå®šä¹‰äº<code>src/msg/Message.h</code>ä¸­ï¼Œæ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>\n<img src=\"/2022/10/22/Ceph%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E6%A0%BC%E5%BC%8F.png\" class=\"\" title=\"æ¶ˆæ¯å‘é€æ ¼å¼\">\n\n<p>å…¶ä¸­ï¼Œheaderæ˜¯æ¶ˆæ¯å¤´ï¼Œç±»ä¼¼ä¸€ä¸ªæ¶ˆæ¯çš„ä¿¡å°ï¼ˆenvelopeï¼‰ï¼Œuser_dataæ˜¯ç”¨äºè¦å‘é€çš„å®é™…æ•°æ®ï¼Œfooteræ˜¯ä¸€ä¸ªæ¶ˆæ¯çš„ç»“æŸæ ‡è®°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Message</span> : <span class=\"keyword\">public</span> RefCountedObject &#123;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    ceph_msg_header header; \t<span class=\"comment\">// æ¶ˆæ¯å¤´</span></span><br><span class=\"line\">    ceph_msg_footer footer;\t\t<span class=\"comment\">// æ¶ˆæ¯å°¾</span></span><br><span class=\"line\">    ceph::buffer::list payload; <span class=\"comment\">// &quot;front&quot; unaligned blob</span></span><br><span class=\"line\">    ceph::buffer::list middle;  <span class=\"comment\">// &quot;middle&quot; unaligned blob</span></span><br><span class=\"line\">    ceph::buffer::list data;\t<span class=\"comment\">// data payload (page-alignment will be preserved where possible)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// æ¶ˆæ¯ç›¸å…³çš„æ—¶é—´æˆ³</span></span><br><span class=\"line\">    <span class=\"type\">utime_t</span> recv_stamp;\t\t\t<span class=\"comment\">// å¼€å§‹æ¥æ”¶æ•°æ®çš„æ—¶é—´æˆ³</span></span><br><span class=\"line\">    <span class=\"type\">utime_t</span> dispatch_stamp;\t\t<span class=\"comment\">// dispatchçš„æ—¶é—´æˆ³</span></span><br><span class=\"line\">    <span class=\"type\">utime_t</span> throttle_stamp;\t\t<span class=\"comment\">// è·å–throttleçš„slotçš„æ—¶é—´æˆ³</span></span><br><span class=\"line\">    <span class=\"type\">utime_t</span> recv_complete_stamp;<span class=\"comment\">// æ¥æ”¶å®Œæˆçš„æ—¶é—´æˆ³</span></span><br><span class=\"line\"></span><br><span class=\"line\">    ConnectionFRef connection;\t<span class=\"comment\">// ç½‘ç»œè¿æ¥ç±»</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> magic = <span class=\"number\">0</span>;\t\t\t<span class=\"comment\">// æ¶ˆæ¯çš„é­”æœ¯å­—</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">    boost::intrusive::list_member_hook&lt;&gt; dispatch_q; <span class=\"comment\">//boost::intrusiveéœ€è¦çš„å­—æ®µ</span></span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ä¸‹é¢åˆ†åˆ«ä»‹ç»å…¶ä¸­çš„é‡è¦å‚æ•°ã€‚</p>\n<p>ceph_msg_header ä¸ºæ¶ˆæ¯å¤´ï¼Œå®ƒå®šä¹‰äº†æ¶ˆæ¯ä¼ è¾“ç›¸å…³çš„å…ƒæ•°æ®ï¼Œåœ¨<code>src/include/msgr.h</code>ä¸­ï¼š</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">ceph_msg_header</span> &#123;</span><br><span class=\"line\">\t__le64 seq;       \t\t<span class=\"comment\">// å½“å‰sessionå†…æ¶ˆæ¯çš„å”¯ä¸€åºå·</span></span><br><span class=\"line\">\t__le64 tid;       \t\t<span class=\"comment\">// æ¶ˆæ¯çš„å…¨å±€å”¯ä¸€id</span></span><br><span class=\"line\">\t__le16 type;      \t\t<span class=\"comment\">// æ¶ˆæ¯ç±»å‹</span></span><br><span class=\"line\">\t__le16 priority;  \t\t<span class=\"comment\">// ä¼˜å…ˆçº§</span></span><br><span class=\"line\">\t__le16 version;   \t\t<span class=\"comment\">// æ¶ˆæ¯ç¼–ç çš„ç‰ˆæœ¬</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t__le32 front_len;\t\t<span class=\"comment\">// payloadçš„é•¿åº¦</span></span><br><span class=\"line\">\t__le32 middle_len;\t\t<span class=\"comment\">// middleçš„é•¿åº¦</span></span><br><span class=\"line\">\t__le32 data_len;  \t\t<span class=\"comment\">// dataçš„é•¿åº¦</span></span><br><span class=\"line\">\t__le16 data_off;  \t\t<span class=\"comment\">// å¯¹è±¡çš„æ•°æ®åç§»é‡</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">struct</span> <span class=\"title class_\">ceph_entity_name</span> src; \t<span class=\"comment\">// æ¶ˆæ¯æº</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// ä¸€äº›æ—§çš„ä»£ç ï¼Œç”¨äºå…¼å®¹ï¼Œå¦‚æœä¸º0å°±å¿½ç•¥</span></span><br><span class=\"line\">\t__le16 compat_version;</span><br><span class=\"line\">\t__le16 reserved;</span><br><span class=\"line\">\t__le32 crc;       \t\t<span class=\"comment\">// æ¶ˆæ¯å¤´çš„crc32cæ ¡éªŒä¿¡æ¯</span></span><br><span class=\"line\">&#125; __attribute__ ((packed));</span><br></pre></td></tr></table></figure>\n\n<p>ceph_msg_footer ä¸ºæ¶ˆæ¯çš„å°¾éƒ¨ï¼Œ é™„åŠ äº†ä¸€äº› crc æ ¡éªŒæ•°æ®å’Œæ¶ˆæ¯ç»“æŸæ ‡å¿—ï¼š</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">ceph_msg_footer</span> &#123;</span><br><span class=\"line\">\t__le32 front_crc, middle_crc, data_crc;</span><br><span class=\"line\">                                <span class=\"comment\">// åˆ†åˆ«å¯¹åº”crcæ ¡éªŒç </span></span><br><span class=\"line\">\t__le64  sig;\t\t\t\t<span class=\"comment\">// æ¶ˆæ¯çš„64ä¸ºsignature</span></span><br><span class=\"line\">\t__u8 flags;\t\t\t\t\t<span class=\"comment\">// ç»“æŸæ ‡å¿—</span></span><br><span class=\"line\">&#125; __attribute__ ((packed));</span><br></pre></td></tr></table></figure>\n\n<p>æ¶ˆæ¯å¸¦çš„æ•°æ®åˆ†åˆ«ä¿å­˜åœ¨ payloadã€ middleã€ data è¿™ä¸‰ä¸ª bufferlist ä¸­ã€‚ payload â€”èˆ¬ä¿<br>å­˜ Ceph æ“ä½œç›¸å…³çš„å…ƒæ•°æ®ï¼Œ middle ç›®å‰æ²¡æœ‰ä½¿ç”¨åˆ°ï¼Œ dataâ€”èˆ¬ä¸ºè¯»å†™çš„æ•°æ®ã€‚</p>\n<h4 id=\"Connection\"><a href=\"#Connection\" class=\"headerlink\" title=\"Connection\"></a>Connection</h4><p>ç±»Connectionå¯¹åº”ç«¯ï¼ˆportï¼‰å¯¹ç«¯çš„socketé“¾æ¥çš„å°è£…ã€‚å®šä¹‰äº<code>src/msg/Connection.h</code>ä¸­ï¼Œå…¶æœ€é‡è¦çš„æ¥å£æ˜¯å¯ä»¥å‘é€æ¶ˆæ¯ï¼š</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Connection</span> : <span class=\"keyword\">public</span> RefCountedObjectSafe &#123;</span><br><span class=\"line\">    <span class=\"keyword\">mutable</span> ceph::mutex lock = ceph::<span class=\"built_in\">make_mutex</span>(<span class=\"string\">&quot;Connection::lock&quot;</span>); <span class=\"comment\">// é”ä¿æŠ¤Connnectionçš„æ‰€æœ‰å­—æ®µ</span></span><br><span class=\"line\">    Messenger *msgr;\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    RefCountedPtr priv;\t\t\t\t\t\t\t\t<span class=\"comment\">// é“¾æ¥çš„ç§æœ‰æ•°æ®</span></span><br><span class=\"line\">    <span class=\"type\">int</span> peer_type = <span class=\"number\">-1</span>;\t\t\t\t\t\t\t\t<span class=\"comment\">// é“¾æ¥çš„peerç±»å‹</span></span><br><span class=\"line\">    <span class=\"type\">int64_t</span> peer_id = <span class=\"number\">-1</span>; \t\t\t\t\t\t\t<span class=\"comment\">// [msgr2 only] the 0 of osd.0, 4567 or client.4567</span></span><br><span class=\"line\">    safe_item_history&lt;<span class=\"type\">entity_addrvec_t</span>&gt; peer_addrs; <span class=\"comment\">// peerçš„åœ°å€ï¼ˆå’ŒğŸ“•ä¸­çš„ç±»å‹ä¸ä¸€æ ·ï¼‰</span></span><br><span class=\"line\">    <span class=\"type\">utime_t</span> last_keepalive, last_keepalive_ack;\t\t<span class=\"comment\">// æœ€åä¸€æ¬¡å‘é€keepaliveå’Œæœ€åä¸€æ¬¡æ¥æ”¶keepaliveçš„ACKçš„æ—¶é—´</span></span><br><span class=\"line\">    <span class=\"type\">bool</span> anon = <span class=\"literal\">false</span>; \t\t\t\t\t\t\t\t<span class=\"comment\">// &lt; anonymous outgoing connection</span></span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">    <span class=\"type\">uint64_t</span> features = <span class=\"number\">0</span>;\t\t\t\t\t\t\t<span class=\"comment\">// ä¸€äº›featureçš„æ ‡å¿—ä½</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"type\">bool</span> is_loopback = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"type\">bool</span> failed = <span class=\"literal\">false</span>; \t\t\t\t\t\t\t<span class=\"comment\">// å½“å€¼ä¸ºtrueæ—¶ï¼Œè¯¥é“¾æ¥ä¸ºlossyé“¾æ¥å·²ç»å¤±æ•ˆäº†</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">int</span> rx_buffers_version = <span class=\"number\">0</span>;\t\t\t\t\t\t<span class=\"comment\">// æ¥æ”¶ç¼“å†²åŒºçš„ç‰ˆæœ¬</span></span><br><span class=\"line\">    std::map&lt;<span class=\"type\">ceph_tid_t</span>, std::pair&lt;ceph::buffer::list, <span class=\"type\">int</span>&gt;&gt; rx_buffers; <span class=\"comment\">// æ¥æ”¶ç¼“å†²åŒº</span></span><br><span class=\"line\">    \t\t\t\t\t\t\t\t\t\t\t\t<span class=\"comment\">// æ¶ˆæ¯çš„æ ‡è¯†ceph_tid --&gt; (buffer, rx_buffers_version)çš„æ˜ å°„</span></span><br><span class=\"line\">    ......</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">int</span> <span class=\"title\">send_message</span><span class=\"params\">(Message *m)</span> </span>= <span class=\"number\">0</span>;\t\t<span class=\"comment\">// æœ€é‡è¦çš„åŠŸèƒ½æ˜¯å‘æ¶ˆæ¯çš„æ¥å£</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Dispatcher\"><a href=\"#Dispatcher\" class=\"headerlink\" title=\"Dispatcher\"></a>Dispatcher</h4><p>ç±»Dispatcheræ˜¯æ¶ˆæ¯åˆ†å‘çš„æ¥å£ï¼Œå®šä¹‰äº<code>src/msg/Dispatcher.h</code>ä¸­ï¼Œå…¶åˆ†å‘æ¶ˆæ¯çš„æ¥å£ä¸ºï¼š</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">bool</span> <span class=\"title\">ms_dispatch</span><span class=\"params\">(Message *m)</span> </span>&#123; <span class=\"built_in\">ceph_abort</span>(); &#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">void</span> <span class=\"title\">ms_fast_dispatch</span><span class=\"params\">(Message *m)</span> </span>&#123; <span class=\"built_in\">ceph_abort</span>(); &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Messenger\"><a href=\"#Messenger\" class=\"headerlink\" title=\"Messenger\"></a>Messenger</h4><p>Messenger æ˜¯æ•´ä¸ªç½‘ç»œæŠ½è±¡æ¨¡å—ï¼Œå®šä¹‰äº†ç½‘ç»œæ¨¡å—çš„åŸºæœ¬ API æ¥å£ã€‚ç½‘ç»œæ¨¡å—å¯¹å¤–æä¾›çš„åŸºæœ¬åŠŸèƒ½ï¼Œå°±æ˜¯èƒ½åœ¨èŠ‚ç‚¹ä¹‹é—´å‘é€å’Œæ¥å—æ¶ˆæ¯ã€‚Messengerå®šä¹‰äº<code>src/msg/Messenger.h</code>ä¸­ã€‚</p>\n<p>å‘ä¸€ä¸ªèŠ‚ç‚¹å‘é€æ¶ˆæ¯çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">int</span> <span class=\"title\">send_to</span><span class=\"params\">(Message *m, <span class=\"type\">int</span> type, <span class=\"type\">const</span> <span class=\"type\">entity_addrvec_t</span> &amp;addr)</span> </span>= <span class=\"number\">0</span>;</span><br></pre></td></tr></table></figure>\n\n<p>æ³¨å†Œä¸€ä¸ªDispatcherç”¨æ¥åˆ†å‘æ¶ˆæ¯çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">add_dispatcher_head</span><span class=\"params\">(Dispatcher *d)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"type\">bool</span> first = dispatchers.<span class=\"built_in\">empty</span>();</span><br><span class=\"line\">        dispatchers.<span class=\"built_in\">push_front</span>(d);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (d-&gt;<span class=\"built_in\">ms_can_fast_dispatch_any</span>())</span><br><span class=\"line\">            fast_dispatchers.<span class=\"built_in\">push_front</span>(d);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (first)</span><br><span class=\"line\">            <span class=\"built_in\">ready</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"ç½‘ç»œè¿æ¥çš„ç­–ç•¥\"><a href=\"#ç½‘ç»œè¿æ¥çš„ç­–ç•¥\" class=\"headerlink\" title=\"ç½‘ç»œè¿æ¥çš„ç­–ç•¥\"></a>ç½‘ç»œè¿æ¥çš„ç­–ç•¥</h4><p>Policyå®šä¹‰äº†Messengerå¤„ç†Connectionçš„ä¸€äº›ç­–ç•¥ï¼Œä½äº<code>/src/msg/Policy.h</code>ä¸­ï¼š</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * A Policy describes the rules of a Connection. Is there a limit on how</span></span><br><span class=\"line\"><span class=\"comment\"> * much data this Connection can have locally? When the underlying connection</span></span><br><span class=\"line\"><span class=\"comment\"> * experiences an error, does the Connection disappear? Can this Messenger</span></span><br><span class=\"line\"><span class=\"comment\"> * re-establish the underlying connection?</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">template</span> &lt;<span class=\"keyword\">class</span> <span class=\"title class_\">ThrottleType</span>&gt; <span class=\"keyword\">struct</span> <span class=\"title class_\">Policy</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">bool</span> lossy; \t<span class=\"comment\">// å¦‚æœä¸º true, å½“è¯¥è¿æ¥å‡ºç°é”™è¯¯æ—¶å°±åˆ é™¤</span></span><br><span class=\"line\">    <span class=\"type\">bool</span> server; \t<span class=\"comment\">// å¦‚æœä¸º true, ä¸ºæœåŠ¡ç«¯ï¼Œéƒ½æ˜¯è¢«åŠ¨è¿æ¥</span></span><br><span class=\"line\">    <span class=\"type\">bool</span> standby;\t<span class=\"comment\">// å¦‚æœä¸º true, è¯¥è¿æ¥å¤„äºç­‰å¾…çŠ¶æ€</span></span><br><span class=\"line\">    <span class=\"type\">bool</span> resetcheck;<span class=\"comment\">// å¦‚æœä¸º true, è¯¥è¿æ¥å‡ºé”™åé‡è¿</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/// Server: register lossy client connections.</span></span><br><span class=\"line\">    <span class=\"type\">bool</span> register_lossy_clients = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"comment\">// The net result of this is that a given client can only have one</span></span><br><span class=\"line\">    <span class=\"comment\">// open connection with the server.  If a new connection is made,</span></span><br><span class=\"line\">    <span class=\"comment\">// the old (registered) one is closed by the messenger during the accept</span></span><br><span class=\"line\">    <span class=\"comment\">// process.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     *  The throttler is used to limit how much data is held by Messages from</span></span><br><span class=\"line\"><span class=\"comment\">     *  the associated Connection(s). When reading in a new Message, the</span></span><br><span class=\"line\"><span class=\"comment\">     * Messenger will call throttler-&gt;throttle() for the size of the new</span></span><br><span class=\"line\"><span class=\"comment\">     * Message.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"comment\">// è¯¥ connection ç›¸å…³çš„æµæ§æ“ä½œ</span></span><br><span class=\"line\">    ThrottleType *throttler_bytes;</span><br><span class=\"line\">    ThrottleType *throttler_messages;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// æœ¬åœ°ç«¯çš„ä¸€äº›featureæ ‡å¿—</span></span><br><span class=\"line\">    <span class=\"type\">static</span> <span class=\"keyword\">constexpr</span> <span class=\"type\">uint64_t</span> features_supported&#123;CEPH_FEATURES_SUPPORTED_DEFAULT&#125;;</span><br><span class=\"line\">    <span class=\"comment\">// è¿œç¨‹ç«¯éœ€è¦çš„ä¸€äº› feature æ ‡å¿—</span></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> features_required;</span><br><span class=\"line\">    ......</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"ç½‘ç»œæ¨¡å—çš„ä½¿ç”¨\"><a href=\"#ç½‘ç»œæ¨¡å—çš„ä½¿ç”¨\" class=\"headerlink\" title=\"ç½‘ç»œæ¨¡å—çš„ä½¿ç”¨\"></a>ç½‘ç»œæ¨¡å—çš„ä½¿ç”¨</h4><p>é€šè¿‡ä¸‹é¢æœ€åŸºæœ¬çš„æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„å®ä¾‹ç¨‹åºï¼Œäº†è§£å¦‚ä½•è°ƒç”¨ç½‘ç»œé€šä¿¡æ¨¡å—æä¾›çš„æ¥å£æ¥å®Œæˆæ”¶å‘è¯·æ±‚æ¶ˆæ¯çš„åŠŸèƒ½ã€‚ç›¸å…³ä»£ç ä½äº<code>/src/test/msgr/test_msgr.cc</code>ä¸­ã€‚</p>\n<ol>\n<li><p>Serverç¨‹åºåˆ†æï¼š</p>\n<ul>\n<li><p>è°ƒç”¨Messengerçš„å‡½æ•°createåˆ›å»ºä¸€ä¸ªMessengerå®ä¾‹ï¼š</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\">Messenger *server_msgr2 = Messenger::<span class=\"built_in\">create</span>(g_ceph_context, <span class=\"built_in\">string</span>(<span class=\"built_in\">GetParam</span>()), <span class=\"type\">entity_name_t</span>::<span class=\"built_in\">OSD</span>(<span class=\"number\">0</span>), <span class=\"string\">&quot;server&quot;</span>, <span class=\"built_in\">getpid</span>());</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>è®¾ç½®Messengerå±æ€§ï¼š</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\">server_msgr2-&gt;<span class=\"built_in\">set_auth_client</span>(&amp;dummy_auth);</span><br><span class=\"line\">server_msgr2-&gt;<span class=\"built_in\">set_auth_server</span>(&amp;dummy_auth);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>å¯¹äºserverï¼Œéœ€è¦bindæœåŠ¡ç«¯åœ°å€ï¼š</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\">bind_addr.<span class=\"built_in\">parse</span>(<span class=\"string\">&quot;v2:127.0.0.1:16801&quot;</span>);</span><br><span class=\"line\">server_msgr2-&gt;<span class=\"built_in\">bind</span>(bind_addr);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åˆ›å»ºDispatcherï¼Œå¹¶æ·»åŠ åˆ°Messengerï¼š</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">MarkdownDispatcher <span class=\"title\">srv_dispatcher</span><span class=\"params\">(<span class=\"literal\">true</span>)</span></span>;</span><br><span class=\"line\">server_msgr2-&gt;<span class=\"built_in\">add_dispatcher_head</span>(&amp;srv_dispatcher);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>å¯åŠ¨Messengerï¼š</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\">server_msgr2-&gt;<span class=\"built_in\">start</span>();</span><br><span class=\"line\">server_msgr2-&gt;<span class=\"built_in\">wait</span>();  <span class=\"comment\">// ğŸ“•ä¸­è¯´æœ¬å‡½æ•°å¿…é¡»ç­‰startå®Œæˆæ‰èƒ½è°ƒç”¨(æºä»£ç ä¼¼ä¹æ˜¯ç­‰å¾…1000s)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>Clientç¨‹åºåˆ†æ</p>\n<ul>\n<li><p>è°ƒç”¨Messengerçš„å‡½æ•°createåˆ›å»ºä¸€ä¸ªMessengerå®ä¾‹ï¼š</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\">client_msgr = Messenger::<span class=\"built_in\">create</span>(g_ceph_context, <span class=\"built_in\">string</span>(<span class=\"built_in\">GetParam</span>()),</span><br><span class=\"line\">                                <span class=\"type\">entity_name_t</span>::<span class=\"built_in\">CLIENT</span>(<span class=\"number\">-1</span>), <span class=\"string\">&quot;client&quot;</span>, <span class=\"built_in\">getpid</span>());</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>è®¾ç½®ç›¸å…³ç­–ç•¥ï¼š</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\">client_msgr-&gt;<span class=\"built_in\">set_default_policy</span>(Messenger::Policy::<span class=\"built_in\">lossy_client</span>(<span class=\"number\">0</span>));</span><br><span class=\"line\">client_msgr-&gt;<span class=\"built_in\">set_auth_client</span>(&amp;dummy_auth);</span><br><span class=\"line\">client_msgr-&gt;<span class=\"built_in\">set_auth_server</span>(&amp;dummy_auth);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åˆ›å»ºDispatcherå¹¶æ·»åŠ ï¼Œç”¨äºæ¥æ”¶æ¶ˆæ¯ï¼š</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">MarkdownDispatcher <span class=\"title\">cli_dispatcher</span><span class=\"params\">(<span class=\"literal\">false</span>)</span></span>;</span><br><span class=\"line\">client_msgr-&gt;<span class=\"built_in\">add_dispatcher_head</span>(&amp;cli_dispatcher);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>å¯åŠ¨æ¶ˆæ¯ï¼š</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\">client_msgr-&gt;<span class=\"built_in\">start</span>();</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ä¸‹é¢å¼€å§‹å‘é€è¯·æ±‚ï¼Œå…ˆè·å–ç›®æ ‡Serverçš„é“¾æ¥ï¼š</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\">ConnectionRef conn2 = client_msgr-&gt;<span class=\"built_in\">connect_to</span>(</span><br><span class=\"line\">            server_msgr2-&gt;<span class=\"built_in\">get_mytype</span>(), server_msgr2-&gt;<span class=\"built_in\">get_myaddrs</span>());</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>é€šè¿‡ Connection æ¥å‘é€è¯·æ±‚æ¶ˆæ¯ ï¼š</p>\n  <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\">m = <span class=\"keyword\">new</span> <span class=\"built_in\">MPing</span>();</span><br><span class=\"line\"><span class=\"built_in\">ASSERT_EQ</span>(conn2-&gt;<span class=\"built_in\">send_message</span>(m), <span class=\"number\">0</span>);</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ol>\n<h3 id=\"Asyncå®ç°\"><a href=\"#Asyncå®ç°\" class=\"headerlink\" title=\"Asyncå®ç°\"></a>Asyncå®ç°</h3><p>ğŸ“•ä¸­è®²è¿°çš„æ˜¯Simpleå®ç°ï¼Œä½†ç°åœ¨Asyncç½‘ç»œé€šä¿¡æ¨¡å‹æˆä¸ºäº†Cephé»˜è®¤çš„é€šä¿¡æ–¹å¼ã€‚å‚è€ƒäº†<a href=\"https://blog.csdn.net/bandaoyu/article/details/111962161\">bandaoyuçš„åšå®¢</a>ã€‚</p>\n<h4 id=\"åŸºæœ¬ç±»\"><a href=\"#åŸºæœ¬ç±»\" class=\"headerlink\" title=\"åŸºæœ¬ç±»\"></a>åŸºæœ¬ç±»</h4><ol>\n<li><p>NetHandlerï¼šNetHandlerå°è£…äº†Socketçš„åŸºæœ¬åŠŸèƒ½ã€‚å®šä¹‰äº<code>src/msg/async/net_handler.h</code>ä¸­ã€‚</p>\n <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">namespace</span> ceph &#123;</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">NetHandler</span> &#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">generic_connect</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">entity_addr_t</span> &amp;addr,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                        <span class=\"type\">const</span> <span class=\"type\">entity_addr_t</span> &amp;bind_addr, <span class=\"type\">bool</span> nonblock)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    CephContext *cct;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">create_socket</span><span class=\"params\">(<span class=\"type\">int</span> domain, <span class=\"type\">bool</span> reuse_addr = <span class=\"literal\">false</span>)</span></span>; <span class=\"comment\">// åˆ›å»ºsocket</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">explicit</span> <span class=\"title\">NetHandler</span><span class=\"params\">(CephContext *c)</span> : cct(c) &#123;</span>&#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">set_nonblock</span><span class=\"params\">(<span class=\"type\">int</span> sd)</span></span>;\t\t\t\t\t\t\t\t<span class=\"comment\">// è®¾ç½®socketä¸ºéé˜»å¡</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">set_socket_options</span><span class=\"params\">(<span class=\"type\">int</span> sd, <span class=\"type\">bool</span> nodelay, <span class=\"type\">int</span> size)</span></span>; <span class=\"comment\">// è®¾ç½®socketçš„é€‰é¡¹ï¼šnodelay, buffer size</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">connect</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">entity_addr_t</span> &amp;addr, <span class=\"type\">const</span> <span class=\"type\">entity_addr_t</span> &amp;bind_addr)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Try to reconnect the socket.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * @return    0         success</span></span><br><span class=\"line\"><span class=\"comment\">     *            &gt; 0       just break, and wait for event</span></span><br><span class=\"line\"><span class=\"comment\">     *            &lt; 0       need to goto fail</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">reconnect</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">entity_addr_t</span> &amp;addr, <span class=\"type\">int</span> sd)</span></span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">nonblock_connect</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">entity_addr_t</span> &amp;addr, \t\t<span class=\"comment\">// éé˜»å¡connect</span></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                         <span class=\"type\">const</span> <span class=\"type\">entity_addr_t</span> &amp;bind_addr)</span></span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">set_priority</span><span class=\"params\">(<span class=\"type\">int</span> sd, <span class=\"type\">int</span> priority, <span class=\"type\">int</span> domain)</span></span>;\t<span class=\"comment\">// è®¾ç½®ä¼˜å…ˆçº§</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">&#125; <span class=\"comment\">// namespace ceph</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Workerï¼šWorkerç±»æ˜¯å·¥ä½œçº¿ç¨‹çš„æŠ½è±¡æ¥å£ï¼ŒåŒæ—¶æ·»åŠ äº†listenå’Œconnectæ¥å£ç”¨äºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ç½‘ç»œå¤„ç†ã€‚å…¶å†…éƒ¨åˆ›å»ºä¸€ä¸ªEventCenterç±»ï¼Œè¯¥ç±»ä¿å­˜ç›¸å…³å¤„ç†çš„äº‹ä»¶ã€‚å®šä¹‰äº<code>src/msg/async/Stack.h</code>ä¸­ã€‚</p>\n <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Worker</span> &#123;</span><br><span class=\"line\">\tstd::atomic_uint references;</span><br><span class=\"line\">    EventCenter center;\t<span class=\"comment\">// äº‹ä»¶å¤„ç†ä¸­å¿ƒï¼Œå¤„ç†è¯¥centerçš„æ‰€æœ‰çš„äº‹ä»¶</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// serverç«¯</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">int</span> <span class=\"title\">listen</span><span class=\"params\">(<span class=\"type\">entity_addr_t</span> &amp;addr, <span class=\"type\">unsigned</span> addr_slot,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                       <span class=\"type\">const</span> SocketOptions &amp;opts, ServerSocket *)</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"comment\">// clientä¸»åŠ¨è¿æ¥</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">int</span> <span class=\"title\">connect</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">entity_addr_t</span> &amp;addr, <span class=\"type\">const</span> SocketOptions &amp;opts,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                        ConnectedSocket *socket)</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>PosixWorkerï¼šPosixWorkerå®ç°äº†Workeræ¥å£ï¼Œå®šä¹‰äº<code>src/msg/async/PosixStack.h</code>ä¸­ã€‚</p>\n <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">PosixWorker</span> : <span class=\"keyword\">public</span> Worker &#123;</span><br><span class=\"line\">    ceph::NetHandler net;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">initialize</span><span class=\"params\">()</span> <span class=\"keyword\">override</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"built_in\">PosixWorker</span>(CephContext *c, <span class=\"type\">unsigned</span> i) : <span class=\"built_in\">Worker</span>(c, i), <span class=\"built_in\">net</span>(c) &#123;&#125;</span><br><span class=\"line\">    <span class=\"comment\">// å®ç°äº†Serverç«¯çš„sockåŠŸèƒ½ï¼š</span></span><br><span class=\"line\">    <span class=\"comment\">// åº•å±‚è°ƒç”¨NetHandlerçš„åŠŸèƒ½ï¼Œå®ç°äº†socketçš„bindï¼Œlistenç­‰æ“ä½œï¼Œæœ€åè¿”å›ServerSocketå¯¹è±¡</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">listen</span><span class=\"params\">(<span class=\"type\">entity_addr_t</span> &amp;sa, <span class=\"type\">unsigned</span> addr_slot, <span class=\"type\">const</span> SocketOptions &amp;opt,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">               ServerSocket *socks)</span> <span class=\"keyword\">override</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// å®ç°äº†ä¸»åŠ¨è¿æ¥è¯·æ±‚ã€‚è¿”å›ConnectedSocketå¯¹è±¡ã€‚</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">connect</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">entity_addr_t</span> &amp;addr, <span class=\"type\">const</span> SocketOptions &amp;opts,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                ConnectedSocket *socket)</span> <span class=\"keyword\">override</span></span>;</span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>NetworkStackï¼šæ˜¯ç½‘ç»œåè®®æ ˆçš„æ¥å£ï¼Œå®šä¹‰äº<code>src/msg/async/Stack.h</code>ä¸­ã€‚</p>\n <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">NetworkStack</span> &#123;</span><br><span class=\"line\">    ceph::spinlock pool_spin;\t\t</span><br><span class=\"line\">    <span class=\"type\">bool</span> started = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    CephContext *cct;</span><br><span class=\"line\">    std::vector&lt;Worker *&gt; workers;\t<span class=\"comment\">// workerå·¥ä½œé˜Ÿåˆ—</span></span><br><span class=\"line\">    ......</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>PosixNetworkï¼šå®ç°äº†linuxçš„tcp&#x2F;ipåè®®æ¥å£ï¼Œå®šä¹‰äº<code>src/msg/async/PosixStack.h</code>ä¸­ã€‚DPDKStackå®ç°äº†DPDKçš„æ¥å£ï¼ŒRDMAStackå®ç°äº†IBçš„æ¥å£ã€‚</p>\n <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">PosixNetworkStack</span> : <span class=\"keyword\">public</span> NetworkStack &#123;</span><br><span class=\"line\">    std::vector&lt;std::thread&gt; threads;\t<span class=\"comment\">// çº¿ç¨‹æ± </span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> Worker *<span class=\"title\">create_worker</span><span class=\"params\">(CephContext *c, <span class=\"type\">unsigned</span> worker_id)</span> <span class=\"keyword\">override</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">PosixWorker</span>(c, worker_id);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">explicit</span> <span class=\"title\">PosixNetworkStack</span><span class=\"params\">(CephContext *c)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">spawn_worker</span><span class=\"params\">(std::function&lt;<span class=\"type\">void</span>()&gt; &amp;&amp;func)</span> <span class=\"keyword\">override</span> </span>&#123;</span><br><span class=\"line\">        threads.<span class=\"built_in\">emplace_back</span>(std::<span class=\"built_in\">move</span>(func));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">join_worker</span><span class=\"params\">(<span class=\"type\">unsigned</span> i)</span> <span class=\"keyword\">override</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">ceph_assert</span>(threads.<span class=\"built_in\">size</span>() &gt; i &amp;&amp; threads[i].<span class=\"built_in\">joinable</span>());</span><br><span class=\"line\">        threads[i].<span class=\"built_in\">join</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p> Workerå¯ä»¥ç†è§£ä¸ºå·¥ä½œè€…çº¿ç¨‹ï¼Œå…¶å¯¹åº”ä¸€ä¸ªthreadçº¿ç¨‹ã€‚ä¸ºäº†å…¼å®¹å…¶å®ƒåè®®çš„è®¾è®¡ï¼Œå¯¹åº”çº¿ç¨‹å®šä¹‰åœ¨äº†PosixNetworkStackç±»é‡Œã€‚</p>\n<p> é€šè¿‡ä¸Šè¿°åˆ†æå¯çŸ¥ï¼Œä¸€ä¸ªWorkerå¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶å¯¹åº”ä¸€ä¸ª äº‹ä»¶å¤„ç†ä¸­å¿ƒEventCenterç±»ã€‚</p>\n</li>\n<li><p>EventDriverï¼šæ˜¯ä¸€ä¸ªæŠ½è±¡æ¥å£ï¼Œå®šä¹‰äº†æ·»åŠ äº‹ä»¶ç›‘å¬ï¼Œåˆ é™¤äº‹ä»¶ç›‘å¬ï¼Œè·å–è§¦å‘çš„äº‹ä»¶çš„æ¥å£ã€‚å®šä¹‰äº<code>src/msg/async/Event.h</code>ä¸­ã€‚</p>\n <figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * EventDriver is a wrap of event mechanisms depends on different OS.</span></span><br><span class=\"line\"><span class=\"comment\"> * For example, Linux will use epoll(2), BSD will use kqueue(2) and select will</span></span><br><span class=\"line\"><span class=\"comment\"> * be used for worst condition.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">EventDriver</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"keyword\">virtual</span> ~<span class=\"built_in\">EventDriver</span>() &#123;&#125; <span class=\"comment\">// we want a virtual destructor!!!</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">int</span> <span class=\"title\">init</span><span class=\"params\">(EventCenter *center, <span class=\"type\">int</span> nevent)</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">int</span> <span class=\"title\">add_event</span><span class=\"params\">(<span class=\"type\">int</span> fd, <span class=\"type\">int</span> cur_mask, <span class=\"type\">int</span> mask)</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">int</span> <span class=\"title\">del_event</span><span class=\"params\">(<span class=\"type\">int</span> fd, <span class=\"type\">int</span> cur_mask, <span class=\"type\">int</span> del_mask)</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">int</span> <span class=\"title\">event_wait</span><span class=\"params\">(std::vector&lt;FiredFileEvent&gt; &amp;fired_events,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                           <span class=\"keyword\">struct</span> timeval *tp)</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">int</span> <span class=\"title\">resize_events</span><span class=\"params\">(<span class=\"type\">int</span> newsize)</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"type\">bool</span> <span class=\"title\">need_wakeup</span><span class=\"params\">()</span> </span>&#123; <span class=\"keyword\">return</span> <span class=\"literal\">true</span>; &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p> é’ˆå¯¹ä¸åŒçš„IOå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå®ç°äº†ä¸åŒçš„ç±»ã€‚SelectDriverå®ç°äº†selectçš„æ–¹å¼ï¼›EpollDriverå®ç°äº†epollçš„ç½‘ç»œäº‹ä»¶å¤„ç†æ–¹å¼ï¼›KqueueDriveræ˜¯FreeBSDå®ç°kqueueäº‹ä»¶å¤„ç†æ¨¡å‹ã€‚</p>\n</li>\n<li><p>EventCenterï¼šä¸»è¦ä¿å­˜äº‹ä»¶ï¼ˆåŒ…æ‹¬fileeventï¼Œtimeeventå’Œå¤–éƒ¨äº‹ä»¶ï¼‰å’Œå¤„ç†å®è·µçš„ç›¸å…³å‡½æ•°ã€‚å®šä¹‰äº<code>src/msg/async/Event.h</code>ä¸­ã€‚</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">    </span><br></pre></td></tr></table></figure></li>\n</ol>\n<p><a href=\"https://item.jd.com/12072602.html\">Cephæºç åˆ†æ</a></p>\n","categories":["Ceph"],"tags":["Ceph"]}]