<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="Mini-LSM 项目">
<meta property="og:type" content="article">
<meta property="og:title" content="Mini-LSM">
<meta property="og:url" content="http://example.com/2024/12/12/MiniLSM/index.html">
<meta property="og:site_name" content="zztaki">
<meta property="og:description" content="Mini-LSM 项目">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/12/12/MiniLSM/full_overview.svg">
<meta property="og:image" content="http://example.com/2024/12/12/MiniLSM/week1-overview.svg">
<meta property="og:image" content="http://example.com/2024/12/12/MiniLSM/week2-overview.svg">
<meta property="article:published_time" content="2024-12-12T09:52:57.000Z">
<meta property="article:modified_time" content="2024-12-20T07:24:50.510Z">
<meta property="article:author" content="zztaki">
<meta property="article:tag" content="存储">
<meta property="article:tag" content="LSM">
<meta property="article:tag" content="KV">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/12/12/MiniLSM/full_overview.svg">

<link rel="canonical" href="http://example.com/2024/12/12/MiniLSM/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Mini-LSM | zztaki</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
	  <a target="_blank" rel="noopener" href="https://github.com/zztaki" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">zztaki</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">fitness and bulking~</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-cv">

    <a href="/CV/CV.pdf" rel="section"><i class="fa fa-user fa-fw"></i>CV</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/12/12/MiniLSM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zztaki">
      <meta itemprop="description" content="fitness">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zztaki">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Mini-LSM
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-12 17:52:57" itemprop="dateCreated datePublished" datetime="2024-12-12T17:52:57+08:00">2024-12-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-20 15:24:50" itemprop="dateModified" datetime="2024-12-20T15:24:50+08:00">2024-12-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/" itemprop="url" rel="index"><span itemprop="name">存储引擎</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>13 mins.</span>
            </span>
            <div class="post-description">Mini-LSM 项目</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><img src="/2024/12/12/MiniLSM/full_overview.svg" class="" title="full_overview">

<h1 id="Week1：Mini-LSM"><a href="#Week1：Mini-LSM" class="headerlink" title="Week1：Mini-LSM"></a>Week1：Mini-LSM</h1><img src="/2024/12/12/MiniLSM/week1-overview.svg" class="" title="week1-overview">

<h2 id="Memtable"><a href="#Memtable" class="headerlink" title="Memtable"></a>Memtable</h2><h3 id="tasks"><a href="#tasks" class="headerlink" title="tasks"></a>tasks</h3><ol>
<li>基于现有的无锁 SkipList，实现 memtable 的 get 和 put 接口；</li>
<li>为 LsmStorageInner 实现 get、put 和 delete 接口，只需考虑将请求分派到当前 memtable；</li>
<li>当 memtable 大小达到阈值时，需冻结成 immutable memtable，并创建新的 memtable；</li>
<li>当有 memtable 和多个 immutable memtable 存在时，完善 LsmStorageInner 的 get 接口；</li>
</ol>
<h3 id="Questions"><a href="#Questions" class="headerlink" title="Questions"></a>Questions</h3><ol>
<li><p>为什么 memtable 不提供 delete API？</p>
<p>memtable 的 delete 没有意义。在 LSM 的查找过程中，需要查找 memtable-&gt;immemtable-&gt;sst，因此，delete 无法减少后续对 immemtable 和 sst 的查找，反而 delete 后，在后续的 get 操作时可能错误地取得一个过期数据；</p>
</li>
<li><p>是否可以使用其他数据结构作为 LSM 中的 memtable？使用跳跃列表的优点&#x2F;缺点是什么？</p>
<p>（1）可以使用红黑树，B+ 树替代；</p>
<p>（2）优点：平均查询时间较低，为 O(logn)；范围查询时间较低，为 O(logn)；缺点：平均插入时间较高，为 O(logn)；依赖随机化策略，因此性能可能退化成 O(n)；需要额外的空间存储结点指针；（n 为 memtable 中的 kv 对数量）</p>
</li>
<li><p>为什么我们需要 <code>state</code> 和 <code>state_lock</code> 的组合？我们可以只使用 <code>state.read()</code>和<code>state.write()</code> 吗？</p>
<p>多个线程在 append 数据时同时触发 freeze，需要使用 state_lock 同步 state 状态的修改，否则将出现未达到阈值的新建立的 memtable 被错误 freeze；</p>
</li>
<li><p>为什么存储和查询 memtables 的顺序很重要？如果一个 key 出现在多个 memtables 中，你应该返回哪个版本给用户？</p>
<p>在 LSM 中，所有操作都是 append 的，因此只有最近的操作结果是有效的；</p>
<p>返回最新的 memtable 中的结果；</p>
</li>
<li><p>memtable 的内存布局是否高效&#x2F;是否具有良好的数据局部性？ （想想 <code>Byte</code> 是如何实现并存储在skiplist 中的……）有哪些可能的优化可以让 memtable 更加高效？</p>
<p>并不具备好的数据局部性，因为 memtable 中的 k 或者 v 只是存储指针，而它们之间的顺序也仅是通过链表连接，随机 IO 比较多；</p>
<p>预先分配大片连续空间以供 memtable 使用；</p>
</li>
<li><p>在本教程中使用 <code>parking_lot</code> 锁。它的读写锁是公平锁吗？如果有一个写入器等待现有读取器停止，那么尝试获取锁的读取器可能会发生什么情况？</p>
<p>是公平锁；等待时间最长的将获得锁。</p>
</li>
<li><p>冻结 memtable 后，是否有可能某些线程仍然保留旧的 LSM 状态并写入这些不可变的 memtable？您的解决方案如何防止这种情况发生？</p>
<p>不会；通过 state.write() 锁；</p>
</li>
</ol>
<h2 id="Merge-Iterator"><a href="#Merge-Iterator" class="headerlink" title="Merge Iterator"></a>Merge Iterator</h2><h3 id="tasks-1"><a href="#tasks-1" class="headerlink" title="tasks"></a>tasks</h3><ol>
<li>实现 memtable 迭代器，包含：<code>key</code>, <code>value</code>,  <code>next</code> 和 <code>is_valid</code> 函数；为 memtable 实现 scan 接口，返回值即 memtable 迭代器；</li>
<li>实现 merge 迭代器，通过多个 memtable 的迭代器进行构建，较新的 memtable 中的数据将覆盖较旧的 memtable 中的相同键数据；</li>
<li>继续向上封装 LsmIterator 和 FusedIterator；（LsmIterator 在调用 next 时，需要跳过 value 为空的迭代器）</li>
<li>实现 LSM 的 scan 接口，当前仅需考虑 memtable 和 immemtable；</li>
</ol>
<h2 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h2><h3 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h3><p>Block 编码格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">|             Data Section             |              Offset Section             |      Extra      |</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">| Entry #1 | Entry #2 | ... | Entry #N | Offset #1 | Offset #2 | ... | Offset #N | num_of_elements |</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------------------------------</span><br><span class="line">|                           Entry #1                            | ... |</span><br><span class="line">-----------------------------------------------------------------------</span><br><span class="line">| key_len (2B) | key (keylen) | value_len (2B) | value (varlen) | ... |</span><br><span class="line">-----------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h3 id="tasks-2"><a href="#tasks-2" class="headerlink" title="tasks"></a>tasks</h3><p>实现 SST 块编码，块解码和块迭代器；</p>
<ol>
<li>实现 SST 中最小单元 Block 的构造器和编解码；</li>
<li>实现 Block 迭代器，在创建时可以定位第一个 key 或者指定 key，指定 key 时将使用间接索引 offset 进行二分查找快速定位；</li>
</ol>
<h3 id="Questions-1"><a href="#Questions-1" class="headerlink" title="Questions"></a>Questions</h3><ol>
<li><p>在块中寻找密钥的时间复杂度是多少?</p>
<p>O(logn)；</p>
</li>
<li><p>当您在实现中查找不存在的键时，光标会停在哪里？</p>
<p>num_of_elements 处；</p>
</li>
<li><p>Block 的 kv 对数量是多少？</p>
<p>block.offsets.len()；</p>
</li>
<li><p>Block 可以包含重复 key 吗？</p>
<p>可以，在二分查找指定重复 key 时，光标将达到该 key 首次出现的位置；</p>
</li>
<li><p>如果用户添加大于目标块大小的 key 会发生什么？</p>
<p>如果该 key 是块的第一个键，则被允许，且该块仅包含这一个 kv 对；如果不是块的第一个键，则无法添加；</p>
</li>
<li><p>考虑 LSM 引擎构建在对象存储服务 (S3) 上的情况。您将如何优化&#x2F;更改块格式和参数以使其适合此类服务？</p>
<p>增大目标块大小至 MB 级，以减少对象存储的访问次数；</p>
</li>
</ol>
<h2 id="SST"><a href="#SST" class="headerlink" title="SST"></a>SST</h2><h3 id="Note-1"><a href="#Note-1" class="headerlink" title="Note"></a>Note</h3><p>SST 编码格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">|            Block Section            |                                   Meta Section                                  |           Extra           |</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">| data block #1 | ... | data block #N | ... | (offset, first_key_len (u16), first_key, last_key_len (u16), last_key) #N | Meta Section offset (u32) |</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h3 id="tasks-3"><a href="#tasks-3" class="headerlink" title="tasks"></a>tasks</h3><ol>
<li>实现 SST 构建器，SST 元数据编解码；</li>
<li>实现 SST 迭代器，且可定位指定 key（在 SST 层面基于 Block 的 first key 进行二分查找，再在 Block 内部进行二分 seek）；</li>
<li>实现块缓存（每个 SST 独立维护各自的 block cache）；</li>
</ol>
<h3 id="Questions-2"><a href="#Questions-2" class="headerlink" title="Questions"></a>Questions</h3><ol>
<li><p>在 SST 中查找 key 的时间复杂度是多少？</p>
<p>O(log(m) + log(n))；其中 m 是 SST 中的 block 数量，n 是 block 内部 key 的数量；</p>
</li>
<li><p>当您在实现中查找不存在的 key 时，光标会停在哪里？</p>
<p>第一个大于该 key 的位置；</p>
</li>
<li><p>是否可以（或有必要）对 SST 文件进行就地更新？</p>
<p>没必要，原地更新成本太大，所在 block 的读写放大，以及如果 value 长度改变了，后续的 Meta Section 信息需要大量修改；</p>
</li>
<li><p>SST 通常很大（即 256MB）。在这种情况下，复制&#x2F;扩展<code>Vec</code>的成本将是巨大的。您的实现是否提前为 SST 构建器分配了足够的空间？你是如何实施的？</p>
<p>在构建 SST 时，根据 estimated_size() 预分配容量；</p>
</li>
<li><p>是否可以在 LSM 引擎中存储列式数据（即包含 100 个整数列的表）？当前的 SST 格式仍然是一个不错的选择吗？</p>
</li>
<li><p>考虑 LSM 引擎构建在对象存储服务（即 S3）上的情况。您将如何优化&#x2F;更改 SST 格式&#x2F;参数和块缓存以使其适合此类服务？</p>
<p>块存储可以不再局限内存，亦可以包括本地 SSD；</p>
</li>
</ol>
<h2 id="Read-Path"><a href="#Read-Path" class="headerlink" title="Read Path"></a>Read Path</h2><h3 id="tasks-4"><a href="#tasks-4" class="headerlink" title="tasks"></a>tasks</h3><ol>
<li>实现 <code>TwoMergeIterator&lt;X, Y&gt;</code>，其中 X 和 Y 分别是内存中 memtable 的合并迭代器和磁盘中 SST 的合并迭代器；简单使用一个标志来标记当前需要读取哪个迭代器（每次 <code>TwoMergeIterator.next()</code> 后需要保证 X 和 Y 的迭代器头部 value 不为空，再通过比较 X 和 Y 的首个 key 的大小决定标记值）；</li>
<li>有了 SST 后，修改 Mini-LSM 的 scan 接口；（对每个 memtable 做 scan，对每个 SST 做 seek_to_key，再将 memtable 的合并迭代器和 SST 的合并迭代器合并成 TwoMergeIterator）</li>
<li>接着修改 Mini-LSM 的 get 接口；（依次对 memtable 做 get，再对每个 SST 做 seek_to_key，多个 SST 迭代器合并，check 合并迭代器的队首元素）</li>
</ol>
<h2 id="Write-Path"><a href="#Write-Path" class="headerlink" title="Write Path"></a>Write Path</h2><h3 id="tasks-5"><a href="#tasks-5" class="headerlink" title="tasks"></a>tasks</h3><ol>
<li>将 memtable 刷新到 SST；（当 imm_memtabls 数量达到阈值时，后台 flush 线程通过 SsTableBuilder 将最早的 imm_memtable 刷新成一个 SST）</li>
<li>Flush Trigger；</li>
<li>Filter the SSTs；（每个 SST 有 first_key 和 last_key 信息，因此在 get 和 scan 时，可以检查是否在 first_key~last_key 范围内，从而过滤不可能的 SST，减轻读放大）</li>
</ol>
<h3 id="Questions-3"><a href="#Questions-3" class="headerlink" title="Questions"></a>Questions</h3><ol>
<li><p>如果用户两次请求删除某个密钥会发生什么？</p>
<p>存在两条 “key: EMPTY” 记录；</p>
</li>
</ol>
<h2 id="SST-Optimizations"><a href="#SST-Optimizations" class="headerlink" title="SST Optimizations"></a>SST Optimizations</h2><h3 id="Note-2"><a href="#Note-2" class="headerlink" title="Note"></a>Note</h3><p>有了布隆过滤器后，SST 编码格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">|            Block Section            |                                   Meta Section                                  |           Extra           |         Bloom Filter        |           Extra            |</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">| data block #1 | ... | data block #N | ... | (offset, first_key_len (u16), first_key, last_key_len (u16), last_key) #N | Meta Section offset (u32) | bits | num_of_hash_function |  Bloom Filter Offset (u32) |</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h3 id="tasks-6"><a href="#tasks-6" class="headerlink" title="tasks"></a>tasks</h3><ol>
<li>布隆过滤器；（每个 SST 有一个独有的布隆过滤器，创建 SST 的同时，根据 SST 中的所有 key 来确定布隆过滤器所需 hash 函数个数、总位数以及各个位置的 bit 值，作为只读过滤器）</li>
<li>在 get 路径上使用布隆过滤器，减轻 SST 的读放大；（在 key_with_sst 的基础上，查询只读过滤器，如果一定不存在，则可以跳过该 SST 的读取）</li>
<li>使用前缀编码节省 block 的磁盘存储成本；（block 的 first_key 作为标杆，后续每个 key 使用 <code>key_overlap_len (u16) | rest_key_len (u16) | key (rest_key_len)</code> 进行压缩，如某个 block 中第一个 key 为 <code>mini-something</code>，该 block 中另一个 key 为 <code>5|3|LSM</code>，则解码后为 <code>mini-LSM</code>）</li>
</ol>
<h3 id="Questions-4"><a href="#Questions-4" class="headerlink" title="Questions"></a>Questions</h3><ol>
<li><p>布隆过滤器如何帮助 SST 过滤过程？它可以告诉您有关密钥的哪些信息？ （可能不存在&#x2F;可能存在&#x2F;必须存在&#x2F;必须不存在）</p>
<p>通过多个哈希函数，将 key 映射到多个 bit，并将这些 bit 置为 1；后续在判断 SST 中是否可能存在某个 key 时，检查查询 key 对应的 bit 位置是否全为 1，如果全为 1，则 可能存在，否则，必定不存在；</p>
</li>
<li><p>考虑我们需要一个向后迭代器的情况。我们的密钥压缩会影响向后迭代器吗？</p>
<p>不会，按需解码即可；</p>
</li>
<li><p>您可以在扫描时使用布隆过滤器吗？</p>
<p>理论上可以，但需要对扫描范围的所有 key 进行判断，且只要范围内有一个 key 存在，也将需要读取对应 SST，因此得不偿失；</p>
</li>
<li><p>对相邻键而不是块中的第一个键进行键前缀编码可能有什么优点&#x2F;缺点？</p>
<p>优点：因为相邻键公共前缀长度往往更大，因此大概率可以节省更多的磁盘空间；</p>
<p>缺点：频繁点查时需要从 block 的第一个 key 开始读起，以解码中间位置的真实 key 值，将导致点查时间成本过高；范围查询接近第一个键前缀编码，但也会有些微时间性能损失。</p>
</li>
</ol>
<h1 id="Week-2：Compaction-Persistence"><a href="#Week-2：Compaction-Persistence" class="headerlink" title="Week 2：Compaction + Persistence"></a>Week 2：Compaction + Persistence</h1><h2 id="Overview-1"><a href="#Overview-1" class="headerlink" title="Overview"></a>Overview</h2><img src="/2024/12/12/MiniLSM/week2-overview.svg" class="" title="week2-overview">

<h2 id="Compaction-Implementation"><a href="#Compaction-Implementation" class="headerlink" title="Compaction Implementation"></a>Compaction Implementation</h2><p>将 L0 SSTs 合并到一个 sorted run （每个 SST 都不包含重叠的 key 范围，且依次按照它们的首 key 有序）中；（从 L1 开始往下，每一层可以理解成是一个 sorted run）</p>
<h3 id="tasks-7"><a href="#tasks-7" class="headerlink" title="tasks"></a>tasks</h3><ol>
<li>实现 force_full_compaction，定期对 L0 和 L1 进行 full compaction，压缩后的 sorted run 加入 L1 层；（从 L0 和 L1 的合并迭代器中创建有序压缩后的 SST 磁盘文件-&gt;获取 LsmState 快照-&gt;从 LsmState 快照中删除压缩前的 L0 和 L1 SST 内存结构-&gt;向 LsmState 快照中添加压缩后的 SST 内存结构-&gt;使用 LsmState 快照更新 LsmState-&gt;删除压缩前的 L0 和 L1 的 SST 磁盘文件）</li>
<li>由于从 L1 开始往下都是 sorted run，因此对于它们无需使用基于堆的 MergeIterator，仅需使用一个串联迭代器进行简化；</li>
<li>有了 L1 层后，完善 LSM 的 scan 和 get 接口；</li>
</ol>
<h3 id="Questions-5"><a href="#Questions-5" class="headerlink" title="Questions"></a>Questions</h3><ol>
<li><p>读&#x2F;写&#x2F;空间放大的定义是什么？</p>
<p>读放大系数：对磁盘发起的实际读取数据量 &#x2F; 上层应用实际需要的数据量；</p>
<p>写放大系数：对磁盘发起的总写入数据量 &#x2F; 上层应用发起的总写入数据量；</p>
<p>空间放大系数：磁盘的总占用空间 &#x2F; 上层应用逻辑视图的总数据量；</p>
</li>
<li><p>有哪些方法可以准确计算读&#x2F;写&#x2F;空间放大，以及估计它们的方法是什么？</p>
<p>读&#x2F;写放大往往可以较为准确地进行估计，参考上面的两种系数定义；</p>
<p>空间放大不好估计，因为对于存储引擎来说，无法探测上层应用实际使用的数据量大小，一个简易的估计方式是：在稳定的工作负载模式下，用户的新增数据量和删除数据量应该接近，即用户实际使用的数据量从某时开始不再发生变化，因此，最后一层的 SST 包含用户数据在某个时刻的快照。因此，空间放大可以简易估计为 <strong>磁盘的总占用空间 &#x2F; 最后一层SST所占用的空间</strong>；</p>
</li>
<li><p>即使用户请求删除密钥也会占用一些存储空间，这是否正确？</p>
<p>正确，由于 LSM 引擎不原地更新，因此 delete 操作必须记录下来；在后续进行 compaction 时，可以不再进行保存；</p>
</li>
<li><p>使用&#x2F;填充块缓存进行压缩是个好主意吗？或者压缩时完全绕过块缓存更好？</p>
<p>不是一个好主意；完全绕过更好。</p>
<p>压缩完成后，先前进行压缩的 SST 将被删除，因此对应的块缓存将不再被使用，压缩过程中填充块缓存将变得没有意义。当然，在这个过程中使用原有块缓存可以一定程度上加速压缩的速度，或许一个好的方式是压缩过程中使用完的块缓存直接从内存中主动删除，腾出宝贵的缓存空间。</p>
</li>
<li><p>系统中拥有  <code>struct ConcatIterator&lt;I: StorageIterator&gt;</code> 是否有意义？</p>
<p>有意义；从 L1 往下都是 sorted run，因此，无需使用基于堆的 MergeIterator 对整层 SST 进行合并，从而加快从迭代器中读取和 seek key 的速度；</p>
</li>
</ol>
<h2 id="Simple-Leveled-Compaction"><a href="#Simple-Leveled-Compaction" class="headerlink" title="Simple Leveled Compaction"></a>Simple Leveled Compaction</h2><p>实现经典的分级压缩算法并使用压缩模拟器来查看其工作效果如何；</p>
<h2 id="Tiered-x2F-Universal-Compaction"><a href="#Tiered-x2F-Universal-Compaction" class="headerlink" title="Tiered&#x2F;Universal Compaction"></a>Tiered&#x2F;Universal Compaction</h2><p>实现 RocksDB 通用压缩算法并了解其优缺点；</p>
<h2 id="Leveled-Compaction"><a href="#Leveled-Compaction" class="headerlink" title="Leveled Compaction"></a>Leveled Compaction</h2><p>实现 RocksDB 分级压缩算法。该压缩算法还支持部分压缩，以减少峰值空间使用；</p>
<h2 id="Manifest"><a href="#Manifest" class="headerlink" title="Manifest"></a>Manifest</h2><p>把 LSM 状态存储在磁盘上并从该状态中恢复；</p>
<h2 id="Write-Ahead-Log-WAL"><a href="#Write-Ahead-Log-WAL" class="headerlink" title="Write-Ahead Log (WAL)"></a>Write-Ahead Log (WAL)</h2><p>用户请求将被路由到 memtable 和 WAL，以便所有操作都将被持久化；</p>
<h2 id="Write-Batch-and-Checksums"><a href="#Write-Batch-and-Checksums" class="headerlink" title="Write Batch and Checksums"></a>Write Batch and Checksums</h2><p>为所有存储格式实现批量写入 API（为第 3 周的 MVCC 做准备）和校验和；</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%AD%98%E5%82%A8/" rel="tag"># 存储</a>
              <a href="/tags/LSM/" rel="tag"># LSM</a>
              <a href="/tags/KV/" rel="tag"># KV</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/04/25/hello-world/" rel="prev" title="Hello World">
      <i class="fa fa-chevron-left"></i> Hello World
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Week1%EF%BC%9AMini-LSM"><span class="nav-number">2.</span> <span class="nav-text">Week1：Mini-LSM</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Memtable"><span class="nav-number">2.1.</span> <span class="nav-text">Memtable</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#tasks"><span class="nav-number">2.1.1.</span> <span class="nav-text">tasks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Questions"><span class="nav-number">2.1.2.</span> <span class="nav-text">Questions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Merge-Iterator"><span class="nav-number">2.2.</span> <span class="nav-text">Merge Iterator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#tasks-1"><span class="nav-number">2.2.1.</span> <span class="nav-text">tasks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Block"><span class="nav-number">2.3.</span> <span class="nav-text">Block</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Note"><span class="nav-number">2.3.1.</span> <span class="nav-text">Note</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tasks-2"><span class="nav-number">2.3.2.</span> <span class="nav-text">tasks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Questions-1"><span class="nav-number">2.3.3.</span> <span class="nav-text">Questions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SST"><span class="nav-number">2.4.</span> <span class="nav-text">SST</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Note-1"><span class="nav-number">2.4.1.</span> <span class="nav-text">Note</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tasks-3"><span class="nav-number">2.4.2.</span> <span class="nav-text">tasks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Questions-2"><span class="nav-number">2.4.3.</span> <span class="nav-text">Questions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Read-Path"><span class="nav-number">2.5.</span> <span class="nav-text">Read Path</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#tasks-4"><span class="nav-number">2.5.1.</span> <span class="nav-text">tasks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Write-Path"><span class="nav-number">2.6.</span> <span class="nav-text">Write Path</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#tasks-5"><span class="nav-number">2.6.1.</span> <span class="nav-text">tasks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Questions-3"><span class="nav-number">2.6.2.</span> <span class="nav-text">Questions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SST-Optimizations"><span class="nav-number">2.7.</span> <span class="nav-text">SST Optimizations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Note-2"><span class="nav-number">2.7.1.</span> <span class="nav-text">Note</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tasks-6"><span class="nav-number">2.7.2.</span> <span class="nav-text">tasks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Questions-4"><span class="nav-number">2.7.3.</span> <span class="nav-text">Questions</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Week-2%EF%BC%9ACompaction-Persistence"><span class="nav-number">3.</span> <span class="nav-text">Week 2：Compaction + Persistence</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Overview-1"><span class="nav-number">3.1.</span> <span class="nav-text">Overview</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Compaction-Implementation"><span class="nav-number">3.2.</span> <span class="nav-text">Compaction Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#tasks-7"><span class="nav-number">3.2.1.</span> <span class="nav-text">tasks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Questions-5"><span class="nav-number">3.2.2.</span> <span class="nav-text">Questions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Simple-Leveled-Compaction"><span class="nav-number">3.3.</span> <span class="nav-text">Simple Leveled Compaction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tiered-x2F-Universal-Compaction"><span class="nav-number">3.4.</span> <span class="nav-text">Tiered&#x2F;Universal Compaction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Leveled-Compaction"><span class="nav-number">3.5.</span> <span class="nav-text">Leveled Compaction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Manifest"><span class="nav-number">3.6.</span> <span class="nav-text">Manifest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Write-Ahead-Log-WAL"><span class="nav-number">3.7.</span> <span class="nav-text">Write-Ahead Log (WAL)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Write-Batch-and-Checksums"><span class="nav-number">3.8.</span> <span class="nav-text">Write Batch and Checksums</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zztaki</p>
  <div class="site-description" itemprop="description">fitness</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zztaki</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">92k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">2:34</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>

